<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Debug Profundo de Duplicaci√≥n de Tareas</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .debug-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #f8f9fa;
        }
        .debug-section h3 {
            color: #34495e;
            margin-top: 0;
        }
        button {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        .success {
            background: linear-gradient(45deg, #27ae60, #229954);
        }
        .warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }
        .info {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }
        .result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .success-result {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error-result {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info-result {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .warning-result {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .task-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .task-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
        }
        .task-card.unique {
            border-left-color: #27ae60;
        }
        .task-card.duplicate {
            border-left-color: #e74c3c;
        }
        .task-id {
            font-weight: bold;
            color: #2c3e50;
        }
        .task-name {
            color: #34495e;
            margin: 5px 0;
        }
        .task-meta {
            font-size: 11px;
            color: #7f8c8d;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #e74c3c;
        }
        .stat-label {
            color: #7f8c8d;
            margin-top: 5px;
        }
        .trace-log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Profundo de Duplicaci√≥n de Tareas</h1>
        
        <div class="stats" id="stats">
            <!-- Las estad√≠sticas se llenar√°n din√°micamente -->
        </div>

        <div class="debug-section">
            <h3>üìä An√°lisis de Duplicaci√≥n</h3>
            <button onclick="analyzeDuplication()">üîç Analizar Duplicaci√≥n</button>
            <button onclick="traceTaskLifecycle()" class="info">üîÑ Rastrear Ciclo de Vida</button>
            <button onclick="checkLocalStorageChanges()" class="warning">üíæ Verificar Cambios en localStorage</button>
            <button onclick="simulateTaskCreation()" class="success">üß™ Simular Creaci√≥n de Tarea</button>
        </div>

        <div class="debug-section">
            <h3>üìã An√°lisis de Tareas por Proyecto</h3>
            <div id="taskAnalysis" class="task-analysis">
                <!-- El an√°lisis se llenar√° din√°micamente -->
            </div>
        </div>

        <div class="debug-section">
            <h3>üîÑ Log de Rastreo</h3>
            <div id="traceLog" class="trace-log">
                Haz clic en "Rastrear Ciclo de Vida" para comenzar el monitoreo...
            </div>
        </div>

        <div class="debug-section">
            <h3>üìù Resultados del Debug</h3>
            <div id="results" class="result info-result">
                Haz clic en "Analizar Duplicaci√≥n" para comenzar el an√°lisis profundo...
            </div>
        </div>
    </div>

    <script>
        let debugData = null;
        let traceLog = [];

        // Funci√≥n principal de an√°lisis de duplicaci√≥n
        function analyzeDuplication() {
            const results = document.getElementById('results');
            results.className = 'result info-result';
            results.textContent = 'üîç Iniciando an√°lisis profundo de duplicaci√≥n...';

            try {
                // Obtener datos del localStorage
                const portfolioData = localStorage.getItem('mi-dashboard-portfolio');
                if (!portfolioData) {
                    results.className = 'result error-result';
                    results.textContent = '‚ùå No se encontraron datos en localStorage';
                    return;
                }

                const data = JSON.parse(portfolioData);
                const tasksByProject = data.tasksByProject || {};
                const projects = data.projects || [];

                let totalTasks = 0;
                let duplicateTasks = 0;
                let uniqueTasks = 0;
                let projectsWithDuplicates = 0;
                const duplicateDetails = [];
                const taskAnalysis = [];

                // Analizar cada proyecto
                Object.entries(tasksByProject).forEach(([projectId, tasks]) => {
                    const project = projects.find(p => p.id === projectId);
                    const projectName = project ? project.name : `Proyecto ${projectId}`;

                    if (!Array.isArray(tasks)) {
                        console.warn(`‚ö†Ô∏è Proyecto ${projectId} no tiene tareas v√°lidas:`, typeof tasks);
                        return;
                    }

                    totalTasks += tasks.length;

                    // An√°lisis detallado de duplicados
                    const taskIds = new Map(); // ID -> [tareas con ese ID]
                    const contentHashes = new Map(); // Hash -> [tareas con ese contenido]

                    tasks.forEach((task, index) => {
                        // Verificar duplicados por ID
                        if (!taskIds.has(task.id)) {
                            taskIds.set(task.id, []);
                        }
                        taskIds.get(task.id).push({ task, index });

                        // Verificar duplicados por contenido
                        const contentHash = JSON.stringify({
                            name: task.name,
                            duration: task.duration,
                            startDate: task.startDate,
                            endDate: task.endDate,
                            description: task.description,
                            predecessors: task.predecessors,
                            successors: task.successors,
                            cost: task.cost,
                            priority: task.priority,
                            assignedTo: task.assignedTo
                        });

                        if (!contentHashes.has(contentHash)) {
                            contentHashes.set(contentHash, []);
                        }
                        contentHashes.get(contentHash).push({ task, index });
                    });

                    // Identificar duplicados reales
                    const projectDuplicates = [];
                    const projectUnique = [];

                    taskIds.forEach((taskList, taskId) => {
                        if (taskList.length > 1) {
                            // Duplicado por ID
                            projectDuplicates.push({
                                type: 'ID',
                                taskId,
                                count: taskList.length,
                                tasks: taskList
                            });
                            duplicateTasks += taskList.length - 1; // -1 porque una es original
                        } else {
                            projectUnique.push(taskList[0]);
                        }
                    });

                    contentHashes.forEach((taskList, contentHash) => {
                        if (taskList.length > 1) {
                            // Verificar si ya se cont√≥ como duplicado por ID
                            const alreadyCounted = taskList.some(t => 
                                projectDuplicates.some(d => d.taskId === t.task.id)
                            );
                            
                            if (!alreadyCounted) {
                                // Duplicado por contenido
                                projectDuplicates.push({
                                    type: 'CONTENT',
                                    contentHash: contentHash.substring(0, 50) + '...',
                                    count: taskList.length,
                                    tasks: taskList
                                });
                                duplicateTasks += taskList.length - 1;
                            }
                        }
                    });

                    if (projectDuplicates.length > 0) {
                        projectsWithDuplicates++;
                        duplicateDetails.push({
                            projectId,
                            projectName,
                            duplicates: projectDuplicates
                        });
                    }

                    uniqueTasks += projectUnique.length;

                    // Crear an√°lisis para la interfaz
                    taskAnalysis.push({
                        projectId,
                        projectName,
                        totalTasks: tasks.length,
                        uniqueTasks: projectUnique.length,
                        duplicateTasks: projectDuplicates.length,
                        duplicates: projectDuplicates
                    });
                });

                // Actualizar estad√≠sticas
                updateStats({
                    totalTasks,
                    uniqueTasks,
                    duplicateTasks,
                    projectsWithDuplicates,
                    totalProjects: Object.keys(tasksByProject).length
                });

                // Actualizar an√°lisis de tareas
                updateTaskAnalysis(taskAnalysis);

                // Generar reporte detallado
                let reportText = `üîç AN√ÅLISIS PROFUNDO DE DUPLICACI√ìN\n`;
                reportText += `====================================\n\n`;
                reportText += `üìä RESUMEN GENERAL:\n`;
                reportText += `‚Ä¢ Total de tareas: ${totalTasks}\n`;
                reportText += `‚Ä¢ Tareas √∫nicas: ${uniqueTasks}\n`;
                reportText += `‚Ä¢ Tareas duplicadas: ${duplicateTasks}\n`;
                reportText += `‚Ä¢ Proyectos con duplicados: ${projectsWithDuplicates}/${Object.keys(tasksByProject).length}\n\n`;

                if (duplicateDetails.length > 0) {
                    reportText += `üö® DUPLICADOS DETECTADOS:\n\n`;
                    duplicateDetails.forEach(project => {
                        reportText += `üìÅ Proyecto: ${project.projectName} (${project.projectId})\n`;
                        project.duplicates.forEach(dup => {
                            reportText += `  ${dup.type === 'ID' ? 'üÜî' : 'üìÑ'} Duplicado por ${dup.type}: ${dup.count} instancias\n`;
                            if (dup.type === 'ID') {
                                reportText += `    ID: ${dup.taskId}\n`;
                                reportText += `    Nombre: ${dup.tasks[0].task.name}\n`;
                            }
                            reportText += `    Posiciones: ${dup.tasks.map(t => t.index).join(', ')}\n\n`;
                        });
                    });

                    reportText += `üîß POSIBLES CAUSAS:\n`;
                    reportText += `‚Ä¢ M√∫ltiples llamadas a setTasks()\n`;
                    reportText += `‚Ä¢ Problemas en updateCurrentProjectTasks()\n`;
                    reportText += `‚Ä¢ Sincronizaci√≥n con Supabase\n`;
                    reportText += `‚Ä¢ Eventos duplicados en la interfaz\n`;
                    reportText += `‚Ä¢ Problemas en el c√°lculo CPM\n\n`;

                    reportText += `üõ†Ô∏è SOLUCIONES RECOMENDADAS:\n`;
                    reportText += `‚Ä¢ Revisar logs de setTasks en la consola\n`;
                    reportText += `‚Ä¢ Verificar que no haya m√∫ltiples useEffect ejecut√°ndose\n`;
                    reportText += `‚Ä¢ Comprobar sincronizaci√≥n con Supabase\n`;
                    reportText += `‚Ä¢ Usar el rastreador de ciclo de vida\n`;
                } else {
                    reportText += `‚úÖ NO SE DETECTARON DUPLICADOS\n`;
                    reportText += `El problema puede estar en:\n`;
                    reportText += `‚Ä¢ La creaci√≥n de nuevas tareas\n`;
                    reportText += `‚Ä¢ La sincronizaci√≥n en tiempo real\n`;
                    reportText += `‚Ä¢ Problemas de concurrencia\n`;
                }

                results.textContent = reportText;
                results.className = duplicateTasks > 0 ? 'result error-result' : 'result success-result';

                // Guardar datos de debug
                debugData = {
                    timestamp: new Date().toISOString(),
                    summary: {
                        totalTasks,
                        uniqueTasks,
                        duplicateTasks,
                        projectsWithDuplicates
                    },
                    details: duplicateDetails,
                    taskAnalysis
                };

            } catch (error) {
                results.className = 'result error-result';
                results.textContent = `‚ùå Error durante el an√°lisis: ${error.message}`;
            }
        }

        // Rastrear ciclo de vida de tareas
        function traceTaskLifecycle() {
            const traceLogElement = document.getElementById('traceLog');
            traceLogElement.innerHTML = 'üîÑ Iniciando rastreo del ciclo de vida de tareas...\n';
            traceLog = [];

            // Interceptar localStorage
            const originalSetItem = localStorage.setItem;
            localStorage.setItem = function(key, value) {
                if (key === 'mi-dashboard-portfolio') {
                    const timestamp = new Date().toLocaleTimeString();
                    traceLog.push(`[${timestamp}] localStorage.setItem('${key}')`);
                    
                    try {
                        const data = JSON.parse(value);
                        const tasksByProject = data.tasksByProject || {};
                        Object.entries(tasksByProject).forEach(([projectId, tasks]) => {
                            if (Array.isArray(tasks)) {
                                traceLog.push(`  üìÅ Proyecto ${projectId}: ${tasks.length} tareas`);
                            }
                        });
                    } catch (e) {
                        traceLog.push(`  ‚ùå Error al parsear datos: ${e.message}`);
                    }
                }
                return originalSetItem.apply(this, arguments);
            };

            // Interceptar console.log para detectar setTasks
            const originalConsoleLog = console.log;
            console.log = function(...args) {
                const message = args.join(' ');
                if (message.includes('setTasks') || message.includes('updateCurrentProjectTasks')) {
                    const timestamp = new Date().toLocaleTimeString();
                    traceLog.push(`[${timestamp}] ${message}`);
                }
                return originalConsoleLog.apply(this, arguments);
            };

            // Actualizar log cada segundo
            const updateInterval = setInterval(() => {
                if (traceLog.length > 0) {
                    traceLogElement.innerHTML = traceLog.slice(-20).join('\n');
                    traceLogElement.scrollTop = traceLogElement.scrollHeight;
                }
            }, 1000);

            // Detener despu√©s de 30 segundos
            setTimeout(() => {
                clearInterval(updateInterval);
                localStorage.setItem = originalSetItem;
                console.log = originalConsoleLog;
                traceLog.push('‚èπÔ∏è Rastreo detenido');
                traceLogElement.innerHTML = traceLog.join('\n');
            }, 30000);
        }

        // Verificar cambios en localStorage
        function checkLocalStorageChanges() {
            const results = document.getElementById('results');
            results.className = 'result info-result';
            results.textContent = 'üíæ Verificando cambios en localStorage...';

            try {
                const portfolioData = localStorage.getItem('mi-dashboard-portfolio');
                if (!portfolioData) {
                    results.className = 'result error-result';
                    results.textContent = '‚ùå No se encontraron datos en localStorage';
                    return;
                }

                const data = JSON.parse(portfolioData);
                const tasksByProject = data.tasksByProject || {};

                let reportText = `üíæ AN√ÅLISIS DE LOCALSTORAGE\n`;
                reportText += `===========================\n\n`;

                Object.entries(tasksByProject).forEach(([projectId, tasks]) => {
                    reportText += `üìÅ Proyecto: ${projectId}\n`;
                    if (Array.isArray(tasks)) {
                        reportText += `  üìä Total de tareas: ${tasks.length}\n`;
                        
                        // Verificar IDs √∫nicos
                        const taskIds = new Set();
                        const duplicateIds = [];
                        
                        tasks.forEach((task, index) => {
                            if (taskIds.has(task.id)) {
                                duplicateIds.push({ id: task.id, index, name: task.name });
                            } else {
                                taskIds.add(task.id);
                            }
                        });

                        if (duplicateIds.length > 0) {
                            reportText += `  üö® Duplicados por ID: ${duplicateIds.length}\n`;
                            duplicateIds.forEach(dup => {
                                reportText += `    ‚Ä¢ ID: ${dup.id}, Posici√≥n: ${dup.index}, Nombre: ${dup.name}\n`;
                            });
                        } else {
                            reportText += `  ‚úÖ Sin duplicados por ID\n`;
                        }
                    } else {
                        reportText += `  ‚ùå Datos inv√°lidos: ${typeof tasks}\n`;
                    }
                    reportText += `\n`;
                });

                results.textContent = reportText;
                results.className = 'result info-result';

            } catch (error) {
                results.className = 'result error-result';
                results.textContent = `‚ùå Error al verificar localStorage: ${error.message}`;
            }
        }

        // Simular creaci√≥n de tarea
        function simulateTaskCreation() {
            const results = document.getElementById('results');
            results.className = 'result info-result';
            results.textContent = 'üß™ Simulando creaci√≥n de tarea...';

            try {
                // Obtener datos actuales
                const portfolioData = localStorage.getItem('mi-dashboard-portfolio');
                if (!portfolioData) {
                    results.className = 'result error-result';
                    results.textContent = '‚ùå No se encontraron datos en localStorage';
                    return;
                }

                const data = JSON.parse(portfolioData);
                const tasksByProject = data.tasksByProject || {};
                const projects = data.projects || [];

                // Encontrar el primer proyecto activo
                const activeProject = projects.find(p => p.status === 'active');
                if (!activeProject) {
                    results.className = 'result error-result';
                    results.textContent = '‚ùå No se encontr√≥ proyecto activo';
                    return;
                }

                const projectId = activeProject.id;
                const currentTasks = tasksByProject[projectId] || [];

                // Crear nueva tarea de prueba
                const newTask = {
                    id: `debug-task-${Date.now()}`,
                    name: 'Tarea de Prueba Debug',
                    duration: 5,
                    startDate: new Date().toISOString().split('T')[0],
                    endDate: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    progress: 0,
                    predecessors: [],
                    successors: [],
                    cost: 0,
                    priority: 'medium',
                    assignedTo: '',
                    isMilestone: false,
                    isCritical: false,
                    originalDuration: 5,
                    description: 'Tarea creada para debug de duplicaci√≥n'
                };

                // Simular la adici√≥n de la tarea
                const updatedTasks = [...currentTasks, newTask];
                tasksByProject[projectId] = updatedTasks;
                data.tasksByProject = tasksByProject;
                data.timestamp = new Date().toISOString();

                // Guardar en localStorage
                localStorage.setItem('mi-dashboard-portfolio', JSON.stringify(data));

                let reportText = `üß™ SIMULACI√ìN DE CREACI√ìN DE TAREA\n`;
                reportText += `===================================\n\n`;
                reportText += `üìÅ Proyecto: ${activeProject.name} (${projectId})\n`;
                reportText += `üÜî Nueva tarea ID: ${newTask.id}\n`;
                reportText += `üìä Tareas antes: ${currentTasks.length}\n`;
                reportText += `üìä Tareas despu√©s: ${updatedTasks.length}\n\n`;
                reportText += `‚úÖ Tarea agregada exitosamente\n`;
                reportText += `üîÑ Recarga la aplicaci√≥n para ver si se duplica\n`;

                results.textContent = reportText;
                results.className = 'result success-result';

            } catch (error) {
                results.className = 'result error-result';
                results.textContent = `‚ùå Error en simulaci√≥n: ${error.message}`;
            }
        }

        // Actualizar estad√≠sticas
        function updateStats(stats) {
            const statsContainer = document.getElementById('stats');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${stats.totalTasks}</div>
                    <div class="stat-label">Total Tareas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.uniqueTasks}</div>
                    <div class="stat-label">Tareas √önicas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.duplicateTasks}</div>
                    <div class="stat-label">Tareas Duplicadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.projectsWithDuplicates}</div>
                    <div class="stat-label">Proyectos con Duplicados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.totalProjects}</div>
                    <div class="stat-label">Total Proyectos</div>
                </div>
            `;
        }

        // Actualizar an√°lisis de tareas
        function updateTaskAnalysis(analysis) {
            const analysisContainer = document.getElementById('taskAnalysis');
            
            if (analysis.length === 0) {
                analysisContainer.innerHTML = '<p>No hay proyectos para analizar</p>';
                return;
            }

            analysisContainer.innerHTML = analysis.map(project => `
                <div class="task-card ${project.duplicateTasks > 0 ? 'duplicate' : 'unique'}">
                    <div class="task-id">üìÅ ${project.projectName}</div>
                    <div class="task-name">${project.projectId}</div>
                    <div class="task-meta">
                        üìä Total: ${project.totalTasks} | 
                        ‚úÖ √önicas: ${project.uniqueTasks} | 
                        ${project.duplicateTasks > 0 ? 'üö®' : '‚úÖ'} Duplicados: ${project.duplicateTasks}
                    </div>
                    ${project.duplicates.length > 0 ? `
                        <div class="task-meta" style="margin-top: 10px; color: #e74c3c;">
                            ${project.duplicates.map(dup => 
                                `${dup.type === 'ID' ? 'üÜî' : 'üìÑ'} ${dup.count} instancias`
                            ).join(' | ')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Ejecutar an√°lisis autom√°tico al cargar
        window.onload = function() {
            analyzeDuplication();
        };
    </script>
</body>
</html>
