<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Diagn√≥stico de Duplicaci√≥n de Tareas</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #f8f9fa;
        }
        .section h3 {
            color: #34495e;
            margin-top: 0;
        }
        button {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        .danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
        }
        .success {
            background: linear-gradient(45deg, #27ae60, #229954);
        }
        .warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }
        .result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success-result {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error-result {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info-result {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
        }
        .stat-label {
            color: #7f8c8d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Diagn√≥stico de Duplicaci√≥n de Tareas</h1>
        
        <div class="section">
            <h3>üìä Estad√≠sticas Actuales</h3>
            <div class="stats" id="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalTasks">-</div>
                    <div class="stat-label">Total Tareas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="duplicateTasks">-</div>
                    <div class="stat-label">Tareas Duplicadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uniqueTasks">-</div>
                    <div class="stat-label">Tareas √önicas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="projects">-</div>
                    <div class="stat-label">Proyectos</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h3>üîß Acciones de Diagn√≥stico</h3>
            <button onclick="diagnoseTasks()">üîç Diagnosticar Tareas</button>
            <button onclick="checkSupabase()" class="warning">‚òÅÔ∏è Verificar Supabase</button>
            <button onclick="checkLocalStorage()" class="warning">üíæ Verificar localStorage</button>
            <button onclick="cleanDuplicates()" class="danger">üßπ Limpiar Duplicados</button>
            <button onclick="resetData()" class="danger">‚ö†Ô∏è Reset Completo</button>
        </div>

        <div class="section">
            <h3>üìã Resultados del Diagn√≥stico</h3>
            <div id="results" class="result info-result">
                Haz clic en "Diagnosticar Tareas" para comenzar el an√°lisis...
            </div>
        </div>

        <div class="section">
            <h3>üìù Detalles de Tareas por Proyecto</h3>
            <div id="projectDetails" class="result info-result">
                Los detalles se mostrar√°n despu√©s del diagn√≥stico...
            </div>
        </div>
    </div>

    <script>
        // Funci√≥n para diagnosticar tareas
        function diagnoseTasks() {
            const results = document.getElementById('results');
            results.className = 'result info-result';
            results.textContent = 'üîç Iniciando diagn√≥stico de tareas...';

            try {
                // Obtener datos del localStorage
                const portfolioData = localStorage.getItem('mi-dashboard-portfolio');
                if (!portfolioData) {
                    results.className = 'result error-result';
                    results.textContent = '‚ùå No se encontraron datos en localStorage';
                    return;
                }

                const data = JSON.parse(portfolioData);
                const tasksByProject = data.tasksByProject || {};
                const projects = data.projects || [];

                let totalTasks = 0;
                let totalDuplicates = 0;
                let projectDetails = [];

                // Analizar cada proyecto
                for (const projectId in tasksByProject) {
                    const tasks = tasksByProject[projectId] || [];
                    const project = projects.find(p => p.id === projectId);
                    const projectName = project ? project.name : `Proyecto ${projectId}`;

                    // Detectar duplicados
                    const taskIds = new Set();
                    const taskContentHashes = new Set();
                    const uniqueTasks = [];
                    let duplicates = 0;

                    for (const task of tasks) {
                        const contentHash = JSON.stringify({
                            name: task.name,
                            duration: task.duration,
                            startDate: task.startDate,
                            endDate: task.endDate,
                            description: task.description
                        });

                        const isDuplicateById = taskIds.has(task.id);
                        const isDuplicateByContent = taskContentHashes.has(contentHash);

                        if (isDuplicateById || isDuplicateByContent) {
                            duplicates++;
                        } else {
                            taskIds.add(task.id);
                            taskContentHashes.add(contentHash);
                            uniqueTasks.push(task);
                        }
                    }

                    totalTasks += tasks.length;
                    totalDuplicates += duplicates;

                    projectDetails.push({
                        projectId,
                        projectName,
                        totalTasks: tasks.length,
                        uniqueTasks: uniqueTasks.length,
                        duplicates: duplicates,
                        duplicatePercentage: tasks.length > 0 ? ((duplicates / tasks.length) * 100).toFixed(1) : 0
                    });
                }

                // Actualizar estad√≠sticas
                document.getElementById('totalTasks').textContent = totalTasks;
                document.getElementById('duplicateTasks').textContent = totalDuplicates;
                document.getElementById('uniqueTasks').textContent = totalTasks - totalDuplicates;
                document.getElementById('projects').textContent = Object.keys(tasksByProject).length;

                // Mostrar resultados
                let resultText = `üìä DIAGN√ìSTICO COMPLETADO\n\n`;
                resultText += `üìà RESUMEN GENERAL:\n`;
                resultText += `‚Ä¢ Total de tareas: ${totalTasks}\n`;
                resultText += `‚Ä¢ Tareas duplicadas: ${totalDuplicates}\n`;
                resultText += `‚Ä¢ Tareas √∫nicas: ${totalTasks - totalDuplicates}\n`;
                resultText += `‚Ä¢ Porcentaje de duplicados: ${totalTasks > 0 ? ((totalDuplicates / totalTasks) * 100).toFixed(1) : 0}%\n`;
                resultText += `‚Ä¢ Proyectos analizados: ${Object.keys(tasksByProject).length}\n\n`;

                if (totalDuplicates > 0) {
                    resultText += `üö® PROBLEMAS DETECTADOS:\n`;
                    resultText += `‚Ä¢ Se encontraron ${totalDuplicates} tareas duplicadas\n`;
                    resultText += `‚Ä¢ Esto representa un ${((totalDuplicates / totalTasks) * 100).toFixed(1)}% de duplicaci√≥n\n`;
                    resultText += `‚Ä¢ Se recomienda ejecutar la limpieza de duplicados\n\n`;
                } else {
                    resultText += `‚úÖ NO SE DETECTARON DUPLICADOS\n`;
                    resultText += `‚Ä¢ Todas las tareas son √∫nicas\n`;
                    resultText += `‚Ä¢ El sistema est√° funcionando correctamente\n\n`;
                }

                results.textContent = resultText;
                results.className = totalDuplicates > 0 ? 'result error-result' : 'result success-result';

                // Mostrar detalles por proyecto
                let detailsText = `üìã DETALLES POR PROYECTO:\n\n`;
                projectDetails.forEach(project => {
                    detailsText += `üè¢ ${project.projectName}:\n`;
                    detailsText += `  ‚Ä¢ Total tareas: ${project.totalTasks}\n`;
                    detailsText += `  ‚Ä¢ Tareas √∫nicas: ${project.uniqueTasks}\n`;
                    detailsText += `  ‚Ä¢ Duplicados: ${project.duplicates} (${project.duplicatePercentage}%)\n`;
                    detailsText += `  ‚Ä¢ ID: ${project.projectId}\n\n`;
                });

                document.getElementById('projectDetails').textContent = detailsText;
                document.getElementById('projectDetails').className = totalDuplicates > 0 ? 'result error-result' : 'result success-result';

            } catch (error) {
                results.className = 'result error-result';
                results.textContent = `‚ùå Error durante el diagn√≥stico: ${error.message}`;
            }
        }

        // Funci√≥n para verificar Supabase
        function checkSupabase() {
            const results = document.getElementById('results');
            results.className = 'result info-result';
            results.textContent = '‚òÅÔ∏è Verificando conexi√≥n con Supabase...';

            // Simular verificaci√≥n de Supabase
            setTimeout(() => {
                results.className = 'result info-result';
                results.textContent = `‚òÅÔ∏è VERIFICACI√ìN DE SUPABASE:\n\n`;
                results.textContent += `‚Ä¢ URL: https://ogqpsrsssrrytrqoyyph.supabase.co\n`;
                results.textContent += `‚Ä¢ Estado: Conectado (verificar en consola del navegador)\n`;
                results.textContent += `‚Ä¢ Autenticaci√≥n: Verificar en la aplicaci√≥n principal\n`;
                results.textContent += `‚Ä¢ Tabla tasks: Verificar estructura en Supabase Dashboard\n\n`;
                results.textContent += `üí° Para verificar completamente, revisa la consola del navegador en la aplicaci√≥n principal.`;
            }, 1000);
        }

        // Funci√≥n para verificar localStorage
        function checkLocalStorage() {
            const results = document.getElementById('results');
            results.className = 'result info-result';
            results.textContent = 'üíæ Verificando localStorage...';

            try {
                const portfolioData = localStorage.getItem('mi-dashboard-portfolio');
                if (!portfolioData) {
                    results.className = 'result error-result';
                    results.textContent = '‚ùå No se encontraron datos en localStorage';
                    return;
                }

                const data = JSON.parse(portfolioData);
                const size = new Blob([portfolioData]).size;
                const sizeKB = (size / 1024).toFixed(2);

                results.className = 'result success-result';
                results.textContent = `üíæ VERIFICACI√ìN DE LOCALSTORAGE:\n\n`;
                results.textContent += `‚Ä¢ Datos encontrados: ‚úÖ\n`;
                results.textContent += `‚Ä¢ Tama√±o: ${sizeKB} KB\n`;
                results.textContent += `‚Ä¢ √öltima actualizaci√≥n: ${data.timestamp || 'No disponible'}\n`;
                results.textContent += `‚Ä¢ Proyectos: ${data.projects ? data.projects.length : 0}\n`;
                results.textContent += `‚Ä¢ Proyectos con tareas: ${data.tasksByProject ? Object.keys(data.tasksByProject).length : 0}\n\n`;
                results.textContent += `‚úÖ localStorage est√° funcionando correctamente`;

            } catch (error) {
                results.className = 'result error-result';
                results.textContent = `‚ùå Error verificando localStorage: ${error.message}`;
            }
        }

        // Funci√≥n para limpiar duplicados
        function cleanDuplicates() {
            if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de que quieres limpiar las tareas duplicadas?\n\nEsta acci√≥n no se puede deshacer.')) {
                return;
            }

            const results = document.getElementById('results');
            results.className = 'result info-result';
            results.textContent = 'üßπ Limpiando tareas duplicadas...';

            try {
                const portfolioData = localStorage.getItem('mi-dashboard-portfolio');
                if (!portfolioData) {
                    results.className = 'result error-result';
                    results.textContent = '‚ùå No se encontraron datos en localStorage';
                    return;
                }

                const data = JSON.parse(portfolioData);
                const tasksByProject = data.tasksByProject || {};
                let totalCleaned = 0;
                let totalBefore = 0;

                // Limpiar cada proyecto
                for (const projectId in tasksByProject) {
                    const tasks = tasksByProject[projectId] || [];
                    totalBefore += tasks.length;

                    // Detectar y eliminar duplicados
                    const taskIds = new Set();
                    const taskContentHashes = new Set();
                    const uniqueTasks = [];

                    for (const task of tasks) {
                        const contentHash = JSON.stringify({
                            name: task.name,
                            duration: task.duration,
                            startDate: task.startDate,
                            endDate: task.endDate,
                            description: task.description
                        });

                        const isDuplicateById = taskIds.has(task.id);
                        const isDuplicateByContent = taskContentHashes.has(contentHash);

                        if (!isDuplicateById && !isDuplicateByContent) {
                            taskIds.add(task.id);
                            taskContentHashes.add(contentHash);
                            uniqueTasks.push(task);
                        }
                    }

                    tasksByProject[projectId] = uniqueTasks;
                    totalCleaned += (tasks.length - uniqueTasks.length);
                }

                // Guardar datos limpios
                data.tasksByProject = tasksByProject;
                data.timestamp = new Date().toISOString();
                localStorage.setItem('mi-dashboard-portfolio', JSON.stringify(data));

                results.className = 'result success-result';
                results.textContent = `üßπ LIMPIEZA COMPLETADA:\n\n`;
                results.textContent += `‚Ä¢ Tareas antes: ${totalBefore}\n`;
                results.textContent += `‚Ä¢ Tareas despu√©s: ${totalBefore - totalCleaned}\n`;
                results.textContent += `‚Ä¢ Duplicados eliminados: ${totalCleaned}\n`;
                results.textContent += `‚Ä¢ Datos guardados en localStorage\n\n`;
                results.textContent += `‚úÖ La limpieza se complet√≥ exitosamente.\n`;
                results.textContent += `üîÑ Recarga la aplicaci√≥n principal para ver los cambios.`;

                // Actualizar estad√≠sticas
                document.getElementById('totalTasks').textContent = totalBefore - totalCleaned;
                document.getElementById('duplicateTasks').textContent = '0';
                document.getElementById('uniqueTasks').textContent = totalBefore - totalCleaned;

            } catch (error) {
                results.className = 'result error-result';
                results.textContent = `‚ùå Error durante la limpieza: ${error.message}`;
            }
        }

        // Funci√≥n para reset completo
        function resetData() {
            if (!confirm('‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è PELIGRO ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è\n\n¬øEst√°s ABSOLUTAMENTE SEGURO de que quieres eliminar TODOS los datos?\n\nEsta acci√≥n:\n‚Ä¢ Eliminar√° TODOS los proyectos\n‚Ä¢ Eliminar√° TODAS las tareas\n‚Ä¢ Eliminar√° TODOS los datos\n‚Ä¢ NO SE PUEDE DESHACER\n\nEscribe "ELIMINAR TODO" en el siguiente prompt para confirmar.')) {
                return;
            }

            const confirmation = prompt('Para confirmar, escribe exactamente: ELIMINAR TODO');
            if (confirmation !== 'ELIMINAR TODO') {
                alert('‚ùå Confirmaci√≥n incorrecta. Operaci√≥n cancelada.');
                return;
            }

            try {
                // Eliminar datos del localStorage
                localStorage.removeItem('mi-dashboard-portfolio');
                localStorage.removeItem('lastSelectedProjectId');

                // Limpiar estad√≠sticas
                document.getElementById('totalTasks').textContent = '0';
                document.getElementById('duplicateTasks').textContent = '0';
                document.getElementById('uniqueTasks').textContent = '0';
                document.getElementById('projects').textContent = '0';

                const results = document.getElementById('results');
                results.className = 'result success-result';
                results.textContent = `üóëÔ∏è RESET COMPLETO REALIZADO:\n\n`;
                results.textContent += `‚Ä¢ Todos los datos han sido eliminados\n`;
                results.textContent += `‚Ä¢ localStorage limpiado\n`;
                results.textContent += `‚Ä¢ La aplicaci√≥n volver√° al estado inicial\n\n`;
                results.textContent += `‚úÖ Reset completado. Recarga la aplicaci√≥n principal.`;

                document.getElementById('projectDetails').textContent = 'Los datos han sido eliminados.';

            } catch (error) {
                const results = document.getElementById('results');
                results.className = 'result error-result';
                results.textContent = `‚ùå Error durante el reset: ${error.message}`;
            }
        }

        // Ejecutar diagn√≥stico autom√°tico al cargar la p√°gina
        window.onload = function() {
            diagnoseTasks();
        };
    </script>
</body>
</html>
