<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forzar Sincronizaci√≥n de Tareas</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .step { margin: 20px 0; padding: 15px; border-left: 4px solid #007bff; background: #f8f9fa; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .log { background: #000; color: #0f0; padding: 10px; border-radius: 5px; font-family: monospace; max-height: 400px; overflow-y: auto; margin: 10px 0; }
        input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; width: 200px; }
        .task-card { background: #e9ecef; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 4px solid #007bff; }
        .task-card h4 { margin: 0 0 5px 0; color: #007bff; }
        .task-details { font-size: 12px; color: #666; }
        .progress-bar { width: 100%; background: #e9ecef; border-radius: 5px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 20px; background: #007bff; transition: width 0.3s; }
        .progress-text { text-align: center; padding: 5px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ Forzar Sincronizaci√≥n de Tareas</h1>
        <p>Este script te ayudar√° a forzar la sincronizaci√≥n de tareas desde tu aplicaci√≥n local a Supabase.</p>
        
        <div class="step">
            <h3>1. Autenticaci√≥n</h3>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Contrase√±a">
            <button onclick="iniciarSesion()">Iniciar Sesi√≥n</button>
            <button onclick="verificarUsuario()">Verificar Usuario</button>
        </div>
        
        <div class="step">
            <h3>2. Cargar Datos Locales</h3>
            <button onclick="cargarDatosLocales()">Cargar Datos Locales</button>
            <button onclick="cargarDesdeIndexedDB()">Cargar desde IndexedDB</button>
            <button onclick="verificarTareasLocales()">Verificar Tareas Locales</button>
            <button onclick="cargarDesdeAplicacion()" style="background: #28a745;">Cargar desde Aplicaci√≥n</button>
        </div>
        
        <div class="step">
            <h3>3. Sincronizar con Supabase</h3>
            <button onclick="sincronizarTodasLasTareas()" style="background: #28a745;">Sincronizar TODAS las Tareas</button>
            <button onclick="sincronizarTareasPorProyecto()" style="background: #ffc107; color: #000;">Sincronizar por Proyecto</button>
        </div>
        
        <div class="step">
            <h3>4. Progreso de Sincronizaci√≥n</h3>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>
            <div id="progressText" class="progress-text">0% - Esperando...</div>
        </div>
        
        <div class="step">
            <h3>5. Lista de Tareas</h3>
            <div id="tareasList" class="log">
                <p>Haz clic en "Cargar Datos Locales" para ver la lista</p>
            </div>
        </div>
        
        <div class="step">
            <h3>6. Log de Resultados</h3>
            <button onclick="limpiarLog()">Limpiar Log</button>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://ogqpsrsssrrytrqoyyph.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ncXBzcnNzc3JyeXRycW95eXBoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3Nzc5NjAsImV4cCI6MjA3MzM1Mzk2MH0.EqXjG1iefYMZ84Tw-4po98gBV7uRuPoz0idQgJ03pzg';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;
        let currentOrganization = null;
        let localData = null;
        let allTasks = [];
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : type === 'warning' ? '#ffd43b' : '#0f0';
            logDiv.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function limpiarLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        function updateProgress(percentage, text) {
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = text;
        }
        
        async function cargarDesdeIndexedDB() {
            try {
                log('üîç Intentando cargar desde IndexedDB...');
                
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('PortfolioDB', 1);
                    
                    request.onerror = () => {
                        log('‚ùå Error abriendo IndexedDB', 'error');
                        resolve(null);
                    };
                    
                    request.onsuccess = (event) => {
                        const db = event.target.result;
                        const transaction = db.transaction(['portfolio'], 'readonly');
                        const store = transaction.objectStore('portfolio');
                        const getRequest = store.get('portfolio-data');
                        
                        getRequest.onsuccess = () => {
                            if (getRequest.result) {
                                log('‚úÖ Datos encontrados en IndexedDB', 'success');
                                resolve(getRequest.result);
                            } else {
                                log('‚ö†Ô∏è No hay datos en IndexedDB', 'warning');
                                resolve(null);
                            }
                        };
                        
                        getRequest.onerror = () => {
                            log('‚ùå Error leyendo desde IndexedDB', 'error');
                            resolve(null);
                        };
                    };
                    
                    request.onupgradeneeded = () => {
                        log('‚ö†Ô∏è IndexedDB necesita actualizaci√≥n', 'warning');
                        resolve(null);
                    };
                });
                
            } catch (error) {
                log(`‚ùå Error general con IndexedDB: ${error.message}`, 'error');
                return null;
            }
        }
        
        async function verificarUsuario() {
            try {
                log('üîç Verificando usuario actual...');
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error) {
                    log(`‚ùå Error: ${error.message}`, 'error');
                    return;
                }
                
                if (user) {
                    currentUser = user;
                    log(`‚úÖ Usuario autenticado: ${user.email}`, 'success');
                    await cargarOrganizacion();
                } else {
                    log('‚ö†Ô∏è No hay usuario autenticado', 'warning');
                }
            } catch (error) {
                log(`‚ùå Error general: ${error.message}`, 'error');
            }
        }
        
        async function cargarOrganizacion() {
            try {
                log('üè¢ Cargando organizaci√≥n...');
                const { data: organization, error } = await supabase
                    .from('organizations')
                    .select('id, name')
                    .eq('owner_id', currentUser.id)
                    .single();
                
                if (error) {
                    log(`‚ùå Error cargando organizaci√≥n: ${error.message}`, 'error');
                    return;
                }
                
                currentOrganization = organization;
                log(`‚úÖ Organizaci√≥n cargada: ${organization.name} (${organization.id})`, 'success');
            } catch (error) {
                log(`‚ùå Error general: ${error.message}`, 'error');
            }
        }
        
        async function iniciarSesion() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                log('‚ùå Por favor ingresa email y contrase√±a', 'error');
                return;
            }
            
            try {
                log(`üîê Iniciando sesi√≥n con ${email}...`);
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) {
                    log(`‚ùå Error de autenticaci√≥n: ${error.message}`, 'error');
                    return;
                }
                
                currentUser = data.user;
                log(`‚úÖ Sesi√≥n iniciada exitosamente`, 'success');
                await cargarOrganizacion();
                
            } catch (error) {
                log(`‚ùå Error general: ${error.message}`, 'error');
            }
        }
        
        async function cargarDatosLocales() {
            try {
                log('üìã Cargando datos locales...');
                
                // Intentar cargar desde localStorage primero
                let localDataStr = localStorage.getItem('portfolio-data');
                
                // Si no hay datos en localStorage, intentar desde IndexedDB
                if (!localDataStr) {
                    log('‚ö†Ô∏è No hay datos en localStorage, intentando desde IndexedDB...', 'warning');
                    localDataStr = await cargarDesdeIndexedDB();
                }
                
                if (!localDataStr) {
                    log('‚ùå No se encontraron datos locales en localStorage ni IndexedDB', 'error');
                    return;
                }
                
                localData = JSON.parse(localDataStr);
                log(`‚úÖ Datos locales cargados`, 'success');
                
                // Extraer todas las tareas
                allTasks = [];
                if (localData.tasksByProject) {
                    Object.keys(localData.tasksByProject).forEach(projectId => {
                        const tasks = localData.tasksByProject[projectId];
                        tasks.forEach(task => {
                            allTasks.push({
                                ...task,
                                project_id: projectId
                            });
                        });
                    });
                }
                
                log(`‚úÖ Total de tareas encontradas: ${allTasks.length}`, 'success');
                
                // Mostrar resumen por proyecto
                if (localData.tasksByProject) {
                    Object.keys(localData.tasksByProject).forEach(projectId => {
                        const tasks = localData.tasksByProject[projectId];
                        if (tasks.length > 0) {
                            log(`   Proyecto ${projectId}: ${tasks.length} tareas`);
                        }
                    });
                }
                
                mostrarTareas();
                
            } catch (error) {
                log(`‚ùå Error general: ${error.message}`, 'error');
            }
        }
        
        async function verificarTareasLocales() {
            try {
                log('üîç Verificando tareas locales...');
                
                if (!localData || !localData.tasksByProject) {
                    log('‚ùå No hay datos de tareas locales', 'error');
                    return;
                }
                
                let totalTasks = 0;
                Object.keys(localData.tasksByProject).forEach(projectId => {
                    const tasks = localData.tasksByProject[projectId];
                    totalTasks += tasks.length;
                    
                    if (tasks.length > 0) {
                        log(`üìã Proyecto ${projectId}: ${tasks.length} tareas`);
                        tasks.slice(0, 3).forEach(task => {
                            log(`   - ${task.name} (${task.status || 'N/A'})`);
                        });
                        if (tasks.length > 3) {
                            log(`   ... y ${tasks.length - 3} m√°s`);
                        }
                    }
                });
                
                log(`‚úÖ Total de tareas locales: ${totalTasks}`, 'success');
                
            } catch (error) {
                log(`‚ùå Error general: ${error.message}`, 'error');
            }
        }
        
        async function cargarDesdeAplicacion() {
            try {
                log('üîÑ Intentando cargar datos desde la aplicaci√≥n...');
                
                // Intentar acceder a la ventana de la aplicaci√≥n
                if (window.opener && window.opener.localStorage) {
                    log('üîç Accediendo a localStorage de la aplicaci√≥n...', 'info');
                    const appData = window.opener.localStorage.getItem('portfolio-data');
                    if (appData) {
                        localData = JSON.parse(appData);
                        log('‚úÖ Datos cargados desde la aplicaci√≥n (localStorage)', 'success');
                        procesarDatosCargados();
                        return;
                    }
                }
                
                // Intentar acceder a IndexedDB de la aplicaci√≥n
                if (window.opener && window.opener.indexedDB) {
                    log('üîç Accediendo a IndexedDB de la aplicaci√≥n...', 'info');
                    const appData = await cargarDesdeIndexedDB();
                    if (appData) {
                        localData = JSON.parse(appData);
                        log('‚úÖ Datos cargados desde la aplicaci√≥n (IndexedDB)', 'success');
                        procesarDatosCargados();
                        return;
                    }
                }
                
                // Si no se puede acceder a la aplicaci√≥n, mostrar instrucciones
                log('‚ö†Ô∏è No se puede acceder a los datos de la aplicaci√≥n', 'warning');
                log('üí° Instrucciones:', 'info');
                log('   1. Aseg√∫rate de que tu aplicaci√≥n est√© abierta en otra pesta√±a', 'info');
                log('   2. En tu aplicaci√≥n, ve a la consola del navegador', 'info');
                log('   3. Ejecuta: console.log(JSON.stringify(JSON.parse(localStorage.getItem("portfolio-data")), null, 2))', 'info');
                log('   4. Copia el resultado y p√©galo en el campo de abajo', 'info');
                
                // Mostrar campo para pegar datos manualmente
                const manualData = prompt('Pega aqu√≠ los datos de la aplicaci√≥n (JSON):');
                if (manualData) {
                    try {
                        localData = JSON.parse(manualData);
                        log('‚úÖ Datos cargados manualmente', 'success');
                        procesarDatosCargados();
                    } catch (error) {
                        log('‚ùå Error parseando datos manuales: ' + error.message, 'error');
                    }
                }
                
            } catch (error) {
                log(`‚ùå Error general: ${error.message}`, 'error');
            }
        }
        
        function procesarDatosCargados() {
            // Extraer todas las tareas
            allTasks = [];
            if (localData.tasksByProject) {
                Object.keys(localData.tasksByProject).forEach(projectId => {
                    const tasks = localData.tasksByProject[projectId];
                    tasks.forEach(task => {
                        allTasks.push({
                            ...task,
                            project_id: projectId
                        });
                    });
                });
            }
            
            log(`‚úÖ Total de tareas encontradas: ${allTasks.length}`, 'success');
            
            // Mostrar resumen por proyecto
            if (localData.tasksByProject) {
                Object.keys(localData.tasksByProject).forEach(projectId => {
                    const tasks = localData.tasksByProject[projectId];
                    if (tasks.length > 0) {
                        log(`   Proyecto ${projectId}: ${tasks.length} tareas`);
                    }
                });
            }
            
            mostrarTareas();
        }
        
        async function sincronizarTodasLasTareas() {
            if (!currentUser || !currentOrganization) {
                log('‚ùå No hay usuario o organizaci√≥n. Inicia sesi√≥n primero.', 'error');
                return;
            }
            
            if (allTasks.length === 0) {
                log('‚ùå No hay tareas para sincronizar. Carga los datos locales primero.', 'error');
                return;
            }
            
            try {
                log(`üîÑ Sincronizando ${allTasks.length} tareas a Supabase...`);
                updateProgress(0, 'Iniciando sincronizaci√≥n...');
                
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < allTasks.length; i++) {
                    const task = allTasks[i];
                    const progress = Math.round((i / allTasks.length) * 100);
                    updateProgress(progress, `Sincronizando tarea ${i + 1} de ${allTasks.length}...`);
                    
                    try {
                        // Convertir nombres de columnas de camelCase a snake_case
                        const taskData = {
                            ...task,
                            owner_id: currentUser.id,
                            updated_at: new Date().toISOString(),
                            // Convertir nombres de columnas
                            wbs_code: task.wbsCode || task.wbs_code,
                            start_date: task.startDate || task.start_date,
                            end_date: task.endDate || task.end_date,
                            assigned_to: task.assignedTo || task.assigned_to,
                            is_milestone: task.isMilestone || task.is_milestone,
                            original_duration: task.originalDuration || task.original_duration,
                            // Remover campos en camelCase
                            wbsCode: undefined,
                            startDate: undefined,
                            endDate: undefined,
                            assignedTo: undefined,
                            isMilestone: undefined,
                            originalDuration: undefined
                        };
                        
                        const { error } = await supabase
                            .from('tasks')
                            .upsert(taskData, { onConflict: 'id' });
                        
                        if (error) {
                            log(`   ‚ùå Error sincronizando "${task.name}": ${error.message}`, 'error');
                            errorCount++;
                        } else {
                            log(`   ‚úÖ "${task.name}" sincronizada`, 'success');
                            successCount++;
                        }
                        
                    } catch (err) {
                        log(`   ‚ùå Error general con "${task.name}": ${err.message}`, 'error');
                        errorCount++;
                    }
                }
                
                updateProgress(100, `Sincronizaci√≥n completada: ${successCount} exitosas, ${errorCount} errores`);
                log(`‚úÖ Sincronizaci√≥n completada: ${successCount} tareas sincronizadas, ${errorCount} errores`, 'success');
                
            } catch (error) {
                log(`‚ùå Error general: ${error.message}`, 'error');
            }
        }
        
        async function sincronizarTareasPorProyecto() {
            if (!currentUser || !currentOrganization || !localData) {
                log('‚ùå No hay datos para sincronizar. Carga los datos locales primero.', 'error');
                return;
            }
            
            try {
                log('üîÑ Sincronizando tareas por proyecto...');
                
                const projectIds = Object.keys(localData.tasksByProject);
                let totalTasks = 0;
                let totalSuccess = 0;
                let totalErrors = 0;
                
                for (let i = 0; i < projectIds.length; i++) {
                    const projectId = projectIds[i];
                    const tasks = localData.tasksByProject[projectId];
                    
                    if (tasks.length === 0) continue;
                    
                    totalTasks += tasks.length;
                    log(`üìã Sincronizando proyecto ${projectId}: ${tasks.length} tareas`);
                    
                    const tasksToUpsert = tasks.map(task => ({
                        ...task,
                        project_id: projectId,
                        owner_id: currentUser.id,
                        updated_at: new Date().toISOString(),
                        // Convertir nombres de columnas
                        wbs_code: task.wbsCode || task.wbs_code,
                        start_date: task.startDate || task.start_date,
                        end_date: task.endDate || task.end_date,
                        assigned_to: task.assignedTo || task.assigned_to,
                        is_milestone: task.isMilestone || task.is_milestone,
                        original_duration: task.originalDuration || task.original_duration,
                        // Remover campos en camelCase
                        wbsCode: undefined,
                        startDate: undefined,
                        endDate: undefined,
                        assignedTo: undefined,
                        isMilestone: undefined,
                        originalDuration: undefined
                    }));
                    
                    const { error } = await supabase
                        .from('tasks')
                        .upsert(tasksToUpsert, { onConflict: 'id' });
                    
                    if (error) {
                        log(`   ‚ùå Error sincronizando proyecto ${projectId}: ${error.message}`, 'error');
                        totalErrors += tasks.length;
                    } else {
                        log(`   ‚úÖ Proyecto ${projectId}: ${tasks.length} tareas sincronizadas`, 'success');
                        totalSuccess += tasks.length;
                    }
                }
                
                log(`‚úÖ Sincronizaci√≥n por proyecto completada: ${totalSuccess} tareas sincronizadas, ${totalErrors} errores`, 'success');
                
            } catch (error) {
                log(`‚ùå Error general: ${error.message}`, 'error');
            }
        }
        
        function mostrarTareas() {
            const tareasDiv = document.getElementById('tareasList');
            let html = '<h3>üìã Lista de Tareas Locales</h3>';
            
            if (allTasks.length === 0) {
                html += '<p>No se encontraron tareas locales</p>';
            } else {
                html += `<p><strong>Total de tareas:</strong> ${allTasks.length}</p>`;
                
                // Agrupar por proyecto
                const tasksByProject = {};
                allTasks.forEach(task => {
                    if (!tasksByProject[task.project_id]) {
                        tasksByProject[task.project_id] = [];
                    }
                    tasksByProject[task.project_id].push(task);
                });
                
                Object.keys(tasksByProject).forEach(projectId => {
                    const tasks = tasksByProject[projectId];
                    html += `<h4>Proyecto ${projectId} (${tasks.length} tareas):</h4>`;
                    
                    tasks.slice(0, 5).forEach(task => {
                        html += `
                            <div class="task-card">
                                <h4>${task.name}</h4>
                                <div class="task-details">
                                    <strong>Estado:</strong> ${task.status || 'N/A'}<br>
                                    <strong>Prioridad:</strong> ${task.priority || 'N/A'}<br>
                                    <strong>Progreso:</strong> ${task.progress || 0}%<br>
                                    <strong>Duraci√≥n:</strong> ${task.duration || 'N/A'} d√≠as
                                </div>
                            </div>
                        `;
                    });
                    
                    if (tasks.length > 5) {
                        html += `<p>... y ${tasks.length - 5} tareas m√°s</p>`;
                    }
                });
            }
            
            tareasDiv.innerHTML = html;
        }
        
        // Verificar usuario al cargar la p√°gina
        window.onload = function() {
            verificarUsuario();
        };
    </script>
</body>
</html>
