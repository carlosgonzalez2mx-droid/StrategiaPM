<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificar Estructura de Tabla Risks</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .test-section h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        .button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background-color: #2980b9;
        }
        .button.success {
            background-color: #27ae60;
        }
        .button.error {
            background-color: #e74c3c;
        }
        .button.warning {
            background-color: #f39c12;
        }
        .log {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .column-list {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .column-item {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .column-item:last-child {
            border-bottom: none;
        }
        .missing-column {
            color: #e74c3c;
            font-weight: bold;
        }
        .existing-column {
            color: #27ae60;
        }
        .sql-code {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Verificaci√≥n de Estructura de Tabla Risks</h1>
            <p>Herramienta para verificar y corregir la estructura de la tabla risks en Supabase</p>
        </div>

        <div class="test-section">
            <h3>üìä Estado de la Conexi√≥n</h3>
            <div id="connectionStatus" class="status info">
                Verificando conexi√≥n a Supabase...
            </div>
            <button class="button" onclick="checkConnection()">Verificar Conexi√≥n</button>
        </div>

        <div class="test-section">
            <h3>üèóÔ∏è Estructura Actual de la Tabla Risks</h3>
            <div id="structureStatus" class="status info">
                Cargando estructura de la tabla...
            </div>
            <button class="button" onclick="checkTableStructure()">Verificar Estructura</button>
            <div id="structureList"></div>
        </div>

        <div class="test-section">
            <h3>üîß Columnas Faltantes</h3>
            <div id="missingStatus" class="status info">
                Analizando columnas faltantes...
            </div>
            <button class="button" onclick="checkMissingColumns()">Verificar Columnas Faltantes</button>
            <div id="missingColumnsList"></div>
        </div>

        <div class="test-section">
            <h3>üõ†Ô∏è Script SQL para Corregir</h3>
            <div id="sqlStatus" class="status info">
                Generando script SQL...
            </div>
            <button class="button" onclick="generateSQLScript()">Generar Script SQL</button>
            <div id="sqlScript"></div>
        </div>

        <div class="test-section">
            <h3>üß™ Prueba de Guardado de Riesgo</h3>
            <div id="testStatus" class="status info">
                Listo para probar guardado de riesgo
            </div>
            <button class="button" onclick="testRiskSave()">Probar Guardado de Riesgo</button>
        </div>

        <div class="test-section">
            <h3>üìù Log de Actividad</h3>
            <div id="log" class="log"></div>
            <button class="button" onclick="clearLog()">Limpiar Log</button>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Supabase
        let SUPABASE_URL = 'https://your-project.supabase.co';
        let SUPABASE_ANON_KEY = 'your-anon-key';
        
        let supabase;
        let currentTableStructure = [];
        let requiredColumns = [
            'id', 'project_id', 'owner_id', 'created_at', 'updated_at',
            'name', 'description', 'code', 'category', 'phase',
            'probability', 'impact', 'risk_score', 'priority', 'status',
            'owner', 'identified_date', 'review_date', 'response',
            'response_plan', 'contingency_plan', 'trigger_conditions',
            'cost_impact', 'schedule_impact', 'residual_probability',
            'residual_impact', 'monitoring_frequency', 'early_warnings',
            'actual_occurred', 'stakeholders', 'assumptions', 'constraints'
        ];

        // Inicializar Supabase
        async function initSupabase() {
            try {
                // Cargar desde el localStorage si est√° disponible
                const savedConfig = localStorage.getItem('supabase-config');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    if (config.url && config.key) {
                        SUPABASE_URL = config.url;
                        SUPABASE_ANON_KEY = config.key;
                    }
                }

                // Crear cliente Supabase
                supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                log('‚úÖ Supabase inicializado correctamente');
                return true;
            } catch (error) {
                log('‚ùå Error inicializando Supabase: ' + error.message);
                return false;
            }
        }

        // Verificar conexi√≥n
        async function checkConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = 'status info';
            statusDiv.textContent = 'Verificando conexi√≥n...';
            
            try {
                if (!supabase) {
                    await initSupabase();
                }

                // Intentar obtener datos de la tabla projects
                const { data, error } = await supabase
                    .from('projects')
                    .select('id, name')
                    .limit(1);

                if (error) {
                    throw error;
                }

                statusDiv.className = 'status success';
                statusDiv.textContent = '‚úÖ Conexi√≥n exitosa a Supabase';
                log('‚úÖ Conexi√≥n verificada correctamente');
                return true;
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Error de conexi√≥n: ' + error.message;
                log('‚ùå Error de conexi√≥n: ' + error.message);
                return false;
            }
        }

        // Verificar estructura de la tabla
        async function checkTableStructure() {
            const statusDiv = document.getElementById('structureStatus');
            const structureListDiv = document.getElementById('structureList');
            
            statusDiv.className = 'status info';
            statusDiv.textContent = 'Verificando estructura de la tabla risks...';
            
            try {
                if (!supabase) {
                    await initSupabase();
                }

                // Obtener informaci√≥n de la tabla risks
                const { data, error } = await supabase
                    .rpc('get_table_columns', { table_name: 'risks' });

                if (error) {
                    // Si la funci√≥n RPC no existe, usar consulta directa
                    const { data: columns, error: columnsError } = await supabase
                        .from('information_schema.columns')
                        .select('column_name, data_type, is_nullable, column_default')
                        .eq('table_name', 'risks')
                        .order('ordinal_position');

                    if (columnsError) {
                        throw columnsError;
                    }

                    if (sqlError) {
                        // M√©todo 3: Asumir estructura b√°sica y mostrar columnas requeridas
                        log('‚ö†Ô∏è No se puede acceder a la estructura, mostrando columnas requeridas...');
                        currentTableStructure = requiredColumns.map(col => ({
                            column_name: col,
                            data_type: 'unknown',
                            is_nullable: 'YES',
                            column_default: null
                        }));
                    } else {
                        currentTableStructure = columns || [];
                    }
                } else {
                    // Si hay datos, inferir estructura de la muestra
                    if (sampleData && sampleData.length > 0) {
                        const sample = sampleData[0];
                        currentTableStructure = Object.keys(sample).map(key => ({
                            column_name: key,
                            data_type: typeof sample[key] === 'object' ? 'jsonb' : 
                                       typeof sample[key] === 'number' ? 'numeric' : 'text',
                            is_nullable: 'YES',
                            column_default: null
                        }));
                    } else {
                        // Tabla vac√≠a, mostrar columnas requeridas
                        currentTableStructure = requiredColumns.map(col => ({
                            column_name: col,
                            data_type: 'unknown',
                            is_nullable: 'YES',
                            column_default: null
                        }));
                    }
                }

                statusDiv.className = 'status success';
                statusDiv.textContent = `‚úÖ Estructura cargada: ${currentTableStructure.length} columnas encontradas`;
                
                // Mostrar columnas
                structureListDiv.innerHTML = '';
                if (currentTableStructure.length === 0) {
                    structureListDiv.innerHTML = '<p>No se encontraron columnas en la tabla risks</p>';
                } else {
                    const columnsDiv = document.createElement('div');
                    columnsDiv.className = 'column-list';
                    columnsDiv.innerHTML = '<h4>Columnas existentes:</h4>';
                    
                    currentTableStructure.forEach(column => {
                        const columnDiv = document.createElement('div');
                        columnDiv.className = 'column-item existing-column';
                        columnDiv.innerHTML = `
                            <strong>${column.column_name}</strong> 
                            (${column.data_type}) 
                            ${column.is_nullable === 'YES' ? 'NULL' : 'NOT NULL'}
                            ${column.column_default ? `DEFAULT: ${column.column_default}` : ''}
                        `;
                        columnsDiv.appendChild(columnDiv);
                    });
                    
                    structureListDiv.appendChild(columnsDiv);
                }

                log(`‚úÖ Estructura de tabla cargada: ${currentTableStructure.length} columnas`);
                return currentTableStructure;
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Error verificando estructura: ' + error.message;
                log('‚ùå Error verificando estructura: ' + error.message);
                return [];
            }
        }

        // Verificar columnas faltantes
        async function checkMissingColumns() {
            const statusDiv = document.getElementById('missingStatus');
            const missingListDiv = document.getElementById('missingColumnsList');
            
            if (currentTableStructure.length === 0) {
                statusDiv.className = 'status warning';
                statusDiv.textContent = '‚ö†Ô∏è Primero verifica la estructura de la tabla';
                return;
            }

            statusDiv.className = 'status info';
            statusDiv.textContent = 'Analizando columnas faltantes...';
            
            try {
                const existingColumns = currentTableStructure.map(col => col.column_name);
                const missingColumns = requiredColumns.filter(col => !existingColumns.includes(col));
                
                statusDiv.className = missingColumns.length > 0 ? 'status warning' : 'status success';
                statusDiv.textContent = missingColumns.length > 0 
                    ? `‚ö†Ô∏è Faltan ${missingColumns.length} columnas` 
                    : '‚úÖ Todas las columnas requeridas est√°n presentes';
                
                // Mostrar columnas faltantes
                missingListDiv.innerHTML = '';
                if (missingColumns.length === 0) {
                    missingListDiv.innerHTML = '<p>‚úÖ Todas las columnas requeridas est√°n presentes</p>';
                } else {
                    const missingDiv = document.createElement('div');
                    missingDiv.className = 'column-list';
                    missingDiv.innerHTML = '<h4>Columnas faltantes:</h4>';
                    
                    missingColumns.forEach(column => {
                        const columnDiv = document.createElement('div');
                        columnDiv.className = 'column-item missing-column';
                        columnDiv.textContent = column;
                        missingDiv.appendChild(columnDiv);
                    });
                    
                    missingListDiv.appendChild(missingDiv);
                }

                log(`‚úÖ An√°lisis completado: ${missingColumns.length} columnas faltantes`);
                return missingColumns;
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Error analizando columnas: ' + error.message;
                log('‚ùå Error analizando columnas: ' + error.message);
                return [];
            }
        }

        // Generar script SQL
        async function generateSQLScript() {
            const statusDiv = document.getElementById('sqlStatus');
            const sqlDiv = document.getElementById('sqlScript');
            
            if (currentTableStructure.length === 0) {
                statusDiv.className = 'status warning';
                statusDiv.textContent = '‚ö†Ô∏è Primero verifica la estructura de la tabla';
                return;
            }

            statusDiv.className = 'status info';
            statusDiv.textContent = 'Generando script SQL...';
            
            try {
                const existingColumns = currentTableStructure.map(col => col.column_name);
                const missingColumns = requiredColumns.filter(col => !existingColumns.includes(col));
                
                let sqlScript = '-- Script para agregar columnas faltantes a la tabla risks\n';
                sqlScript += '-- Copia y pega este script en el SQL Editor de Supabase\n\n';
                
                if (missingColumns.length === 0) {
                    sqlScript += '-- ‚úÖ Todas las columnas requeridas est√°n presentes\n';
                    sqlScript += '-- No se requieren cambios en la estructura de la tabla\n';
                } else {
                    sqlScript += `-- Agregando ${missingColumns.length} columnas faltantes\n\n`;
                    
                    missingColumns.forEach(column => {
                        const columnDef = getColumnDefinition(column);
                        sqlScript += `ALTER TABLE risks ADD COLUMN IF NOT EXISTS ${columnDef};\n`;
                    });
                    
                    sqlScript += '\n-- Verificar que las columnas se agregaron correctamente\n';
                    sqlScript += 'SELECT column_name, data_type, is_nullable, column_default\n';
                    sqlScript += 'FROM information_schema.columns \n';
                    sqlScript += "WHERE table_name = 'risks' \n";
                    sqlScript += 'ORDER BY ordinal_position;\n';
                }
                
                statusDiv.className = 'status success';
                statusDiv.textContent = '‚úÖ Script SQL generado correctamente';
                
                sqlDiv.innerHTML = `<div class="sql-code">${sqlScript}</div>`;
                
                log('‚úÖ Script SQL generado correctamente');
                return sqlScript;
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Error generando script: ' + error.message;
                log('‚ùå Error generando script: ' + error.message);
                return '';
            }
        }

        // Obtener definici√≥n de columna
        function getColumnDefinition(columnName) {
            const definitions = {
                'actual_occurred': 'actual_occurred BOOLEAN DEFAULT false',
                'early_warnings': 'early_warnings JSONB DEFAULT \'[]\'::jsonb',
                'stakeholders': 'stakeholders JSONB DEFAULT \'[]\'::jsonb',
                'assumptions': 'assumptions JSONB DEFAULT \'[]\'::jsonb',
                'constraints': 'constraints JSONB DEFAULT \'[]\'::jsonb',
                'trigger_conditions': 'trigger_conditions TEXT',
                'response_plan': 'response_plan TEXT',
                'contingency_plan': 'contingency_plan TEXT',
                'residual_probability': 'residual_probability NUMERIC(3,2) DEFAULT 0',
                'residual_impact': 'residual_impact NUMERIC(3,2) DEFAULT 0',
                'cost_impact': 'cost_impact NUMERIC(12,2) DEFAULT 0',
                'schedule_impact': 'schedule_impact INTEGER DEFAULT 0',
                'monitoring_frequency': 'monitoring_frequency TEXT DEFAULT \'weekly\'',
                'identified_date': 'identified_date DATE',
                'review_date': 'review_date DATE',
                'response': 'response TEXT DEFAULT \'mitigate\'',
                'risk_score': 'risk_score NUMERIC(3,2) DEFAULT 0',
                'code': 'code TEXT',
                'phase': 'phase TEXT DEFAULT \'planning\'',
                'category': 'category TEXT DEFAULT \'technical\'',
                'probability': 'probability NUMERIC(3,2) DEFAULT 0.5',
                'impact': 'impact NUMERIC(3,2) DEFAULT 0.5',
                'priority': 'priority TEXT DEFAULT \'medium\'',
                'status': 'status TEXT DEFAULT \'active\'',
                'owner': 'owner TEXT',
                'name': 'name TEXT',
                'description': 'description TEXT'
            };
            
            return definitions[columnName] || `${columnName} TEXT`;
        }

        // Probar guardado de riesgo
        async function testRiskSave() {
            const statusDiv = document.getElementById('testStatus');
            statusDiv.className = 'status info';
            statusDiv.textContent = 'Probando guardado de riesgo...';
            
            try {
                if (!supabase) {
                    await initSupabase();
                }

                // Crear un riesgo de prueba con todas las columnas
                const testRisk = {
                    id: `test-risk-${Date.now()}`,
                    project_id: 'demo-001',
                    name: `Riesgo de Prueba ${new Date().toLocaleTimeString()}`,
                    description: 'Riesgo creado para probar el guardado en Supabase',
                    code: 'TEST-001',
                    category: 'technical',
                    phase: 'planning',
                    probability: 0.7,
                    impact: 0.8,
                    risk_score: 0.56,
                    priority: 'high',
                    status: 'active',
                    owner: 'Sistema de Pruebas',
                    identified_date: new Date().toISOString().split('T')[0],
                    review_date: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    response: 'mitigate',
                    response_plan: 'Implementar medidas preventivas',
                    contingency_plan: 'Plan de contingencia activado',
                    trigger_conditions: 'Condiciones de activaci√≥n',
                    cost_impact: 50000,
                    schedule_impact: 30,
                    residual_probability: 0.3,
                    residual_impact: 0.4,
                    monitoring_frequency: 'weekly',
                    early_warnings: [],
                    actual_occurred: false,
                    stakeholders: [],
                    assumptions: [],
                    constraints: [],
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };

                // Guardar en Supabase
                const { data, error } = await supabase
                    .from('risks')
                    .insert([testRisk])
                    .select();

                if (error) {
                    throw error;
                }

                statusDiv.className = 'status success';
                statusDiv.textContent = '‚úÖ Riesgo guardado exitosamente';
                log('‚úÖ Riesgo de prueba guardado correctamente');
                log(`   ID: ${data[0].id}`);
                log(`   Nombre: ${testRisk.name}`);
                
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = '‚ùå Error guardando riesgo: ' + error.message;
                log('‚ùå Error guardando riesgo: ' + error.message);
                log('   Detalles: ' + JSON.stringify(error, null, 2));
            }
        }

        // Funci√≥n de logging
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Limpiar log
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Inicializar al cargar la p√°gina
        window.onload = async function() {
            log('üöÄ Iniciando verificaci√≥n de estructura de tabla risks...');
            await initSupabase();
            await checkConnection();
        };
    </script>
</body>
</html>
