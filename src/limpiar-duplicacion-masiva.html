<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßπ Limpiar Duplicaci√≥n Masiva</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .alert {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .alert.danger {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .alert.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #007bff;
        }
        .stat-card.danger {
            border-left-color: #dc3545;
        }
        .stat-card.warning {
            border-left-color: #ffc107;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .stat-number.danger {
            color: #dc3545;
        }
        .stat-number.warning {
            color: #ffc107;
        }
        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }
        button {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }
        .success {
            background: linear-gradient(45deg, #28a745, #1e7e34);
        }
        .warning {
            background: linear-gradient(45deg, #ffc107, #e0a800);
            color: #212529;
        }
        .info {
            background: linear-gradient(45deg, #17a2b8, #138496);
        }
        .result {
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .success-result {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error-result {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info-result {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .project-analysis {
            margin: 20px 0;
        }
        .project-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #28a745;
        }
        .project-card.danger {
            border-left-color: #dc3545;
        }
        .project-card.warning {
            border-left-color: #ffc107;
        }
        .project-header {
            font-weight: bold;
            color: #495057;
            margin-bottom: 10px;
        }
        .project-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .project-stat {
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 12px;
        }
        .project-stat.danger {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßπ Limpiar Duplicaci√≥n Masiva</h1>
        
        <div class="alert danger" id="alertMessage">
            <strong>‚ö†Ô∏è ATENCI√ìN:</strong> Esta herramienta est√° dise√±ada para limpiar duplicaci√≥n masiva de tareas. 
            Usa con precauci√≥n y siempre haz backup antes de proceder.
        </div>

        <div class="stats" id="stats">
            <!-- Las estad√≠sticas se llenar√°n din√°micamente -->
        </div>

        <div class="project-analysis" id="projectAnalysis">
            <!-- El an√°lisis por proyecto se llenar√° din√°micamente -->
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button onclick="analyzeMassiveDuplication()">üîç Analizar Duplicaci√≥n Masiva</button>
            <button onclick="cleanMassiveDuplication()" class="danger">üßπ Limpiar Duplicaci√≥n Masiva</button>
            <button onclick="createBackup()" class="warning">üíæ Crear Backup</button>
            <button onclick="restoreBackup()" class="info">üîÑ Restaurar Backup</button>
            <button onclick="exportReport()" class="success">üìä Exportar Reporte</button>
        </div>

        <div id="results" class="result info-result">
            Haz clic en "Analizar Duplicaci√≥n Masiva" para comenzar el an√°lisis...
        </div>
    </div>

    <script>
        let analysisData = null;

        // Funci√≥n principal de an√°lisis de duplicaci√≥n masiva
        function analyzeMassiveDuplication() {
            const results = document.getElementById('results');
            results.className = 'result info-result';
            results.textContent = 'üîç Analizando duplicaci√≥n masiva...';

            try {
                // Obtener datos del localStorage
                const portfolioData = localStorage.getItem('mi-dashboard-portfolio');
                if (!portfolioData) {
                    results.className = 'result error-result';
                    results.textContent = '‚ùå No se encontraron datos en localStorage';
                    return;
                }

                const data = JSON.parse(portfolioData);
                const tasksByProject = data.tasksByProject || {};
                const projects = data.projects || [];

                let totalTasks = 0;
                let totalDuplicates = 0;
                let projectsWithDuplicates = 0;
                const projectAnalysis = [];

                // Analizar cada proyecto
                Object.entries(tasksByProject).forEach(([projectId, tasks]) => {
                    const project = projects.find(p => p.id === projectId);
                    const projectName = project ? project.name : `Proyecto ${projectId}`;

                    if (!Array.isArray(tasks)) {
                        console.warn(`‚ö†Ô∏è Proyecto ${projectId} no tiene tareas v√°lidas:`, typeof tasks);
                        return;
                    }

                    totalTasks += tasks.length;

                    // Detectar duplicados por ID
                    const taskIds = new Map();
                    const duplicateIds = [];

                    tasks.forEach((task, index) => {
                        if (!taskIds.has(task.id)) {
                            taskIds.set(task.id, []);
                        }
                        taskIds.get(task.id).push({ task, index });
                    });

                    // Identificar duplicados
                    taskIds.forEach((taskList, taskId) => {
                        if (taskList.length > 1) {
                            duplicateIds.push({
                                taskId,
                                count: taskList.length,
                                positions: taskList.map(t => t.index)
                            });
                        }
                    });

                    const projectDuplicates = duplicateIds.length;
                    totalDuplicates += duplicateIds.reduce((sum, dup) => sum + (dup.count - 1), 0);

                    if (projectDuplicates > 0) {
                        projectsWithDuplicates++;
                    }

                    projectAnalysis.push({
                        projectId,
                        projectName,
                        totalTasks: tasks.length,
                        duplicateIds: projectDuplicates,
                        duplicateTasks: duplicateIds.reduce((sum, dup) => sum + (dup.count - 1), 0),
                        duplicates: duplicateIds,
                        isMassive: tasks.length > 500,
                        avgDuplicates: projectDuplicates > 0 ? duplicateIds.reduce((sum, dup) => sum + dup.count, 0) / duplicateIds.length : 0
                    });
                });

                // Actualizar estad√≠sticas
                updateStats({
                    totalTasks,
                    totalDuplicates,
                    projectsWithDuplicates,
                    totalProjects: Object.keys(tasksByProject).length
                });

                // Actualizar an√°lisis por proyecto
                updateProjectAnalysis(projectAnalysis);

                // Generar reporte
                let reportText = `üîç AN√ÅLISIS DE DUPLICACI√ìN MASIVA\n`;
                reportText += `===================================\n\n`;
                reportText += `üìä RESUMEN GENERAL:\n`;
                reportText += `‚Ä¢ Total de tareas: ${totalTasks}\n`;
                reportText += `‚Ä¢ Tareas duplicadas: ${totalDuplicates}\n`;
                reportText += `‚Ä¢ Proyectos con duplicados: ${projectsWithDuplicates}/${Object.keys(tasksByProject).length}\n`;
                reportText += `‚Ä¢ Porcentaje de duplicaci√≥n: ${totalTasks > 0 ? ((totalDuplicates / totalTasks) * 100).toFixed(2) : 0}%\n\n`;

                if (totalDuplicates > 0) {
                    reportText += `üö® DUPLICACI√ìN DETECTADA:\n\n`;
                    projectAnalysis.forEach(project => {
                        if (project.duplicateTasks > 0) {
                            reportText += `üìÅ ${project.projectName} (${project.projectId}):\n`;
                            reportText += `  ‚Ä¢ Total tareas: ${project.totalTasks}\n`;
                            reportText += `  ‚Ä¢ Tareas duplicadas: ${project.duplicateTasks}\n`;
                            reportText += `  ‚Ä¢ IDs duplicados: ${project.duplicateIds}\n`;
                            
                            if (project.isMassive) {
                                reportText += `  ‚ö†Ô∏è PROYECTO MASIVO (${project.totalTasks} tareas)\n`;
                            }
                            
                            if (project.duplicates.length > 0) {
                                reportText += `  ‚Ä¢ Detalles de duplicados:\n`;
                                project.duplicates.slice(0, 5).forEach(dup => {
                                    reportText += `    - ${dup.taskId}: ${dup.count} instancias (posiciones: ${dup.positions.join(', ')})\n`;
                                });
                                if (project.duplicates.length > 5) {
                                    reportText += `    ... y ${project.duplicates.length - 5} m√°s\n`;
                                }
                            }
                            reportText += `\n`;
                        }
                    });

                    if (totalDuplicates > 100) {
                        reportText += `üö® DUPLICACI√ìN MASIVA DETECTADA\n`;
                        reportText += `Se recomienda usar la funci√≥n de limpieza masiva.\n\n`;
                    }
                } else {
                    reportText += `‚úÖ NO SE DETECTARON DUPLICADOS\n`;
                    reportText += `El sistema est√° limpio de duplicaci√≥n.\n`;
                }

                results.textContent = reportText;
                results.className = totalDuplicates > 0 ? 'result error-result' : 'result success-result';

                // Actualizar alerta
                const alertElement = document.getElementById('alertMessage');
                if (totalDuplicates > 100) {
                    alertElement.className = 'alert danger';
                    alertElement.innerHTML = `<strong>üö® DUPLICACI√ìN MASIVA DETECTADA:</strong> ${totalDuplicates} tareas duplicadas encontradas. Se recomienda limpiar inmediatamente.`;
                } else if (totalDuplicates > 0) {
                    alertElement.className = 'alert warning';
                    alertElement.innerHTML = `<strong>‚ö†Ô∏è DUPLICACI√ìN DETECTADA:</strong> ${totalDuplicates} tareas duplicadas encontradas. Considera limpiar.`;
                } else {
                    alertElement.className = 'alert success';
                    alertElement.innerHTML = `<strong>‚úÖ SISTEMA LIMPIO:</strong> No se detectaron duplicados. El sistema est√° funcionando correctamente.`;
                }

                // Guardar datos de an√°lisis
                analysisData = {
                    timestamp: new Date().toISOString(),
                    summary: {
                        totalTasks,
                        totalDuplicates,
                        projectsWithDuplicates,
                        totalProjects: Object.keys(tasksByProject).length
                    },
                    projectAnalysis
                };

            } catch (error) {
                results.className = 'result error-result';
                results.textContent = `‚ùå Error durante el an√°lisis: ${error.message}`;
            }
        }

        // Limpiar duplicaci√≥n masiva
        function cleanMassiveDuplication() {
            if (!analysisData || analysisData.summary.totalDuplicates === 0) {
                alert('‚ö†Ô∏è No hay duplicados para limpiar. Primero ejecuta el an√°lisis.');
                return;
            }

            if (!confirm(`‚ö†Ô∏è ¬øEst√°s seguro de que quieres limpiar ${analysisData.summary.totalDuplicates} tareas duplicadas?\n\nEsta acci√≥n no se puede deshacer.`)) {
                return;
            }

            const results = document.getElementById('results');
            results.className = 'result info-result';
            results.textContent = 'üßπ Limpiando duplicaci√≥n masiva...';

            try {
                const portfolioData = localStorage.getItem('mi-dashboard-portfolio');
                if (!portfolioData) {
                    results.className = 'result error-result';
                    results.textContent = '‚ùå No se encontraron datos en localStorage';
                    return;
                }

                const data = JSON.parse(portfolioData);
                const tasksByProject = data.tasksByProject || {};
                let totalCleaned = 0;

                // Limpiar duplicados en cada proyecto
                analysisData.projectAnalysis.forEach(projectAnalysis => {
                    if (projectAnalysis.duplicateTasks > 0) {
                        const projectId = projectAnalysis.projectId;
                        const tasks = tasksByProject[projectId];
                        
                        if (Array.isArray(tasks)) {
                            // Crear mapa de tareas √∫nicas (mantener la primera ocurrencia)
                            const uniqueTasks = [];
                            const seenIds = new Set();
                            
                            tasks.forEach(task => {
                                if (!seenIds.has(task.id)) {
                                    uniqueTasks.push(task);
                                    seenIds.add(task.id);
                                }
                            });
                            
                            tasksByProject[projectId] = uniqueTasks;
                            totalCleaned += tasks.length - uniqueTasks.length;
                        }
                    }
                });

                // Guardar datos limpios
                data.tasksByProject = tasksByProject;
                data.timestamp = new Date().toISOString();
                localStorage.setItem('mi-dashboard-portfolio', JSON.stringify(data));

                results.className = 'result success-result';
                results.textContent = `üßπ LIMPIEZA MASIVA COMPLETADA:\n\n`;
                results.textContent += `‚Ä¢ Tareas duplicadas eliminadas: ${totalCleaned}\n`;
                results.textContent += `‚Ä¢ Proyectos procesados: ${analysisData.projectAnalysis.length}\n`;
                results.textContent += `‚Ä¢ Datos guardados en localStorage\n\n`;
                results.textContent += `‚úÖ La limpieza se complet√≥ exitosamente.\n`;
                results.textContent += `üîÑ Recarga la aplicaci√≥n principal para ver los cambios.\n`;
                results.textContent += `üìä El sistema ahora deber√≠a funcionar sin bloqueos de guardado.`;

                // Actualizar estad√≠sticas
                analysisData.summary.totalDuplicates = 0;
                analysisData.summary.totalTasks -= totalCleaned;
                updateStats(analysisData.summary);

                // Actualizar alerta
                const alertElement = document.getElementById('alertMessage');
                alertElement.className = 'alert success';
                alertElement.innerHTML = `<strong>‚úÖ LIMPIEZA COMPLETADA:</strong> ${totalCleaned} tareas duplicadas eliminadas. El sistema est√° limpio.`;

            } catch (error) {
                results.className = 'result error-result';
                results.textContent = `‚ùå Error durante la limpieza: ${error.message}`;
            }
        }

        // Crear backup
        function createBackup() {
            try {
                const portfolioData = localStorage.getItem('mi-dashboard-portfolio');
                if (!portfolioData) {
                    alert('‚ùå No se encontraron datos para hacer backup');
                    return;
                }

                const backupData = {
                    data: JSON.parse(portfolioData),
                    timestamp: new Date().toISOString(),
                    type: 'massive-duplication-backup'
                };

                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup-duplicacion-masiva-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert('‚úÖ Backup creado exitosamente');

            } catch (error) {
                alert(`‚ùå Error al crear backup: ${error.message}`);
            }
        }

        // Restaurar backup
        function restoreBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const backupData = JSON.parse(e.target.result);
                            if (backupData.type === 'massive-duplication-backup' && backupData.data) {
                                localStorage.setItem('mi-dashboard-portfolio', JSON.stringify(backupData.data));
                                alert('‚úÖ Backup restaurado exitosamente');
                                analyzeMassiveDuplication(); // Re-analizar
                            } else {
                                alert('‚ùå Archivo de backup inv√°lido');
                            }
                        } catch (error) {
                            alert(`‚ùå Error al restaurar backup: ${error.message}`);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Exportar reporte
        function exportReport() {
            if (!analysisData) {
                alert('‚ö†Ô∏è Primero debes ejecutar el an√°lisis.');
                return;
            }

            try {
                const exportData = {
                    ...analysisData,
                    exportDate: new Date().toISOString(),
                    tool: 'Limpiar Duplicaci√≥n Masiva'
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `reporte-duplicacion-masiva-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                alert('‚úÖ Reporte exportado exitosamente');

            } catch (error) {
                alert(`‚ùå Error al exportar: ${error.message}`);
            }
        }

        // Actualizar estad√≠sticas
        function updateStats(stats) {
            const statsContainer = document.getElementById('stats');
            statsContainer.innerHTML = `
                <div class="stat-card ${stats.totalDuplicates > 0 ? 'danger' : ''}">
                    <div class="stat-number ${stats.totalDuplicates > 0 ? 'danger' : ''}">${stats.totalTasks}</div>
                    <div class="stat-label">Total Tareas</div>
                </div>
                <div class="stat-card ${stats.totalDuplicates > 100 ? 'danger' : stats.totalDuplicates > 0 ? 'warning' : ''}">
                    <div class="stat-number ${stats.totalDuplicates > 100 ? 'danger' : stats.totalDuplicates > 0 ? 'warning' : ''}">${stats.totalDuplicates}</div>
                    <div class="stat-label">Tareas Duplicadas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.projectsWithDuplicates}</div>
                    <div class="stat-label">Proyectos con Duplicados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.totalProjects}</div>
                    <div class="stat-label">Total Proyectos</div>
                </div>
            `;
        }

        // Actualizar an√°lisis por proyecto
        function updateProjectAnalysis(projects) {
            const analysisContainer = document.getElementById('projectAnalysis');
            
            if (projects.length === 0) {
                analysisContainer.innerHTML = '<p>No hay proyectos para analizar</p>';
                return;
            }

            analysisContainer.innerHTML = projects.map(project => `
                <div class="project-card ${project.isMassive ? 'danger' : project.duplicateTasks > 0 ? 'warning' : ''}">
                    <div class="project-header">üìÅ ${project.projectName}</div>
                    <div class="project-stats">
                        <div class="project-stat ${project.duplicateTasks > 0 ? 'danger' : ''}">
                            <strong>${project.totalTasks}</strong><br>Tareas
                        </div>
                        <div class="project-stat ${project.duplicateTasks > 0 ? 'danger' : ''}">
                            <strong>${project.duplicateTasks}</strong><br>Duplicadas
                        </div>
                        <div class="project-stat ${project.duplicateIds > 0 ? 'danger' : ''}">
                            <strong>${project.duplicateIds}</strong><br>IDs Duplicados
                        </div>
                        <div class="project-stat">
                            <strong>${project.avgDuplicates.toFixed(1)}</strong><br>Promedio
                        </div>
                    </div>
                    ${project.isMassive ? '<div style="color: #dc3545; font-weight: bold; margin-top: 10px;">‚ö†Ô∏è PROYECTO MASIVO</div>' : ''}
                </div>
            `).join('');
        }

        // Ejecutar an√°lisis autom√°tico al cargar
        window.onload = function() {
            analyzeMassiveDuplication();
        };
    </script>
</body>
</html>
