<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Debug Guardado - Duplicaci√≥n</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .debug-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #f8f9fa;
        }
        .debug-section h3 {
            color: #34495e;
            margin-top: 0;
        }
        button {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        .success {
            background: linear-gradient(45deg, #27ae60, #229954);
        }
        .warning {
            background: linear-gradient(45deg, #f39c12, #e67e22);
        }
        .info {
            background: linear-gradient(45deg, #3498db, #2980b9);
        }
        .result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 11px;
        }
        .success-result {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error-result {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info-result {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .warning-result {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .trace-log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            max-height: 300px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .before-after {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .before-after h4 {
            margin-top: 0;
            color: #495057;
        }
        .comparison {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .comparison.before {
            border-left-color: #28a745;
        }
        .comparison.after {
            border-left-color: #dc3545;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #e74c3c;
        }
        .stat-label {
            color: #7f8c8d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug Guardado - Duplicaci√≥n</h1>
        
        <div class="stats" id="stats">
            <!-- Las estad√≠sticas se llenar√°n din√°micamente -->
        </div>

        <div class="debug-section">
            <h3>üîç An√°lisis de Guardado</h3>
            <button onclick="startSaveMonitoring()">üéØ Iniciar Monitoreo de Guardado</button>
            <button onclick="simulateSave()" class="info">üíæ Simular Guardado</button>
            <button onclick="compareBeforeAfter()" class="warning">‚öñÔ∏è Comparar Antes/Despu√©s</button>
            <button onclick="analyzeSavePattern()" class="success">üìä Analizar Patr√≥n de Guardado</button>
        </div>

        <div class="debug-section">
            <h3>üîÑ Log de Monitoreo</h3>
            <div id="traceLog" class="trace-log">
                Haz clic en "Iniciar Monitoreo de Guardado" para comenzar...
            </div>
        </div>

        <div class="before-after" id="beforeAfter" style="display: none;">
            <div class="comparison before">
                <h4>üì• ANTES del Guardado</h4>
                <div id="beforeData" class="result info-result">
                    <!-- Datos antes del guardado -->
                </div>
            </div>
            <div class="comparison after">
                <h4>üì§ DESPU√âS del Guardado</h4>
                <div id="afterData" class="result info-result">
                    <!-- Datos despu√©s del guardado -->
                </div>
            </div>
        </div>

        <div class="debug-section">
            <h3>üìù Resultados del Debug</h3>
            <div id="results" class="result info-result">
                Haz clic en "Iniciar Monitoreo de Guardado" para comenzar el an√°lisis...
            </div>
        </div>
    </div>

    <script>
        let monitoringActive = false;
        let traceLog = [];
        let beforeSaveData = null;
        let saveCount = 0;
        let originalSetItem = null;
        let originalGetItem = null;

        // Funci√≥n para iniciar monitoreo de guardado
        function startSaveMonitoring() {
            if (monitoringActive) {
                alert('‚ö†Ô∏è El monitoreo ya est√° activo');
                return;
            }

            monitoringActive = true;
            traceLog = [];
            saveCount = 0;

            const traceLogElement = document.getElementById('traceLog');
            traceLogElement.innerHTML = 'üéØ Iniciando monitoreo de guardado...\n';
            traceLog.push(`[${new Date().toLocaleTimeString()}] üéØ Monitoreo iniciado`);

            // Interceptar localStorage.setItem
            originalSetItem = localStorage.setItem;
            localStorage.setItem = function(key, value) {
                if (key === 'mi-dashboard-portfolio') {
                    saveCount++;
                    const timestamp = new Date().toLocaleTimeString();
                    traceLog.push(`[${timestamp}] üíæ SAVE #${saveCount} - localStorage.setItem('${key}')`);
                    
                    try {
                        const data = JSON.parse(value);
                        const tasksByProject = data.tasksByProject || {};
                        
                        // Analizar datos antes de guardar
                        let totalTasks = 0;
                        let projectCount = 0;
                        Object.entries(tasksByProject).forEach(([projectId, tasks]) => {
                            if (Array.isArray(tasks)) {
                                totalTasks += tasks.length;
                                projectCount++;
                                traceLog.push(`  üìÅ Proyecto ${projectId}: ${tasks.length} tareas`);
                                
                                // Detectar duplicados en tiempo real
                                const taskIds = new Set();
                                const duplicates = [];
                                tasks.forEach((task, index) => {
                                    if (taskIds.has(task.id)) {
                                        duplicates.push({ id: task.id, index });
                                    } else {
                                        taskIds.add(task.id);
                                    }
                                });
                                
                                if (duplicates.length > 0) {
                                    traceLog.push(`  üö® DUPLICADOS DETECTADOS en ${projectId}: ${duplicates.length}`);
                                    duplicates.forEach(dup => {
                                        traceLog.push(`    ‚Ä¢ ID: ${dup.id}, Posici√≥n: ${dup.index}`);
                                    });
                                }
                            }
                        });
                        
                        traceLog.push(`  üìä TOTAL: ${totalTasks} tareas en ${projectCount} proyectos`);
                        
                        // Detectar si hay duplicaci√≥n masiva
                        if (totalTasks > 500) {
                            traceLog.push(`  ‚ö†Ô∏è ALERTA: Muchas tareas (${totalTasks})`);
                        }
                        
                    } catch (e) {
                        traceLog.push(`  ‚ùå Error al parsear datos: ${e.message}`);
                    }
                }
                
                return originalSetItem.apply(this, arguments);
            };

            // Interceptar localStorage.getItem para detectar lecturas
            originalGetItem = localStorage.getItem;
            localStorage.getItem = function(key) {
                if (key === 'mi-dashboard-portfolio') {
                    const timestamp = new Date().toLocaleTimeString();
                    traceLog.push(`[${timestamp}] üìñ READ - localStorage.getItem('${key}')`);
                }
                return originalGetItem.apply(this, arguments);
            };

            // Interceptar console.log para detectar mensajes de guardado
            const originalConsoleLog = console.log;
            console.log = function(...args) {
                const message = args.join(' ');
                if (message.includes('Guardando') || message.includes('setTasks') || message.includes('updateCurrentProjectTasks')) {
                    const timestamp = new Date().toLocaleTimeString();
                    traceLog.push(`[${timestamp}] üîß ${message}`);
                }
                return originalConsoleLog.apply(this, arguments);
            };

            // Actualizar log cada segundo
            const updateInterval = setInterval(() => {
                if (traceLog.length > 0) {
                    traceLogElement.innerHTML = traceLog.slice(-30).join('\n');
                    traceLogElement.scrollTop = traceLogElement.scrollHeight;
                }
            }, 1000);

            // Detener despu√©s de 60 segundos
            setTimeout(() => {
                clearInterval(updateInterval);
                stopMonitoring();
                traceLog.push(`[${new Date().toLocaleTimeString()}] ‚èπÔ∏è Monitoreo detenido`);
                traceLogElement.innerHTML = traceLog.join('\n');
            }, 60000);

            const results = document.getElementById('results');
            results.className = 'result info-result';
            results.textContent = 'üéØ Monitoreo activo. Realiza acciones en la aplicaci√≥n para ver el comportamiento del guardado.\n\nEl monitoreo se detendr√° autom√°ticamente en 60 segundos.';
        }

        // Funci√≥n para detener monitoreo
        function stopMonitoring() {
            if (originalSetItem) {
                localStorage.setItem = originalSetItem;
            }
            if (originalGetItem) {
                localStorage.getItem = originalGetItem;
            }
            monitoringActive = false;
        }

        // Funci√≥n para simular guardado
        function simulateSave() {
            const results = document.getElementById('results');
            results.className = 'result info-result';
            results.textContent = 'üíæ Simulando proceso de guardado...';

            try {
                // Capturar datos antes del guardado
                beforeSaveData = captureCurrentData();
                
                // Simular un guardado
                const portfolioData = localStorage.getItem('mi-dashboard-portfolio');
                if (!portfolioData) {
                    results.className = 'result error-result';
                    results.textContent = '‚ùå No se encontraron datos en localStorage';
                    return;
                }

                const data = JSON.parse(portfolioData);
                
                // Simular modificaci√≥n y guardado
                data.timestamp = new Date().toISOString();
                localStorage.setItem('mi-dashboard-portfolio', JSON.stringify(data));

                // Capturar datos despu√©s del guardado
                const afterSaveData = captureCurrentData();

                // Comparar
                compareData(beforeSaveData, afterSaveData);

                results.className = 'result success-result';
                results.textContent = `‚úÖ Simulaci√≥n de guardado completada\n\n`;
                results.textContent += `üìä Guardados detectados: ${saveCount}\n`;
                results.textContent += `üìà Ver la comparaci√≥n arriba para detectar duplicaci√≥n.`;

            } catch (error) {
                results.className = 'result error-result';
                results.textContent = `‚ùå Error en simulaci√≥n: ${error.message}`;
            }
        }

        // Funci√≥n para capturar datos actuales
        function captureCurrentData() {
            const portfolioData = localStorage.getItem('mi-dashboard-portfolio');
            if (!portfolioData) return null;

            const data = JSON.parse(portfolioData);
            const tasksByProject = data.tasksByProject || {};
            
            const capture = {
                timestamp: new Date().toISOString(),
                totalTasks: 0,
                projectCount: 0,
                projects: {}
            };

            Object.entries(tasksByProject).forEach(([projectId, tasks]) => {
                if (Array.isArray(tasks)) {
                    capture.totalTasks += tasks.length;
                    capture.projectCount++;
                    
                    // Detectar duplicados
                    const taskIds = new Set();
                    const duplicates = [];
                    tasks.forEach((task, index) => {
                        if (taskIds.has(task.id)) {
                            duplicates.push({ id: task.id, index, name: task.name });
                        } else {
                            taskIds.add(task.id);
                        }
                    });

                    capture.projects[projectId] = {
                        taskCount: tasks.length,
                        duplicateCount: duplicates.length,
                        duplicates: duplicates
                    };
                }
            });

            return capture;
        }

        // Funci√≥n para comparar datos
        function compareData(before, after) {
            if (!before || !after) {
                console.warn('No hay datos para comparar');
                return;
            }

            const beforeElement = document.getElementById('beforeData');
            const afterElement = document.getElementById('afterData');
            const beforeAfterElement = document.getElementById('beforeAfter');

            // Mostrar datos antes
            let beforeText = `üì• ANTES (${before.timestamp}):\n`;
            beforeText += `‚Ä¢ Total tareas: ${before.totalTasks}\n`;
            beforeText += `‚Ä¢ Proyectos: ${before.projectCount}\n`;
            beforeText += `‚Ä¢ Duplicados totales: ${Object.values(before.projects).reduce((sum, p) => sum + p.duplicateCount, 0)}\n\n`;
            
            Object.entries(before.projects).forEach(([projectId, project]) => {
                beforeText += `üìÅ ${projectId}:\n`;
                beforeText += `  ‚Ä¢ Tareas: ${project.taskCount}\n`;
                beforeText += `  ‚Ä¢ Duplicados: ${project.duplicateCount}\n`;
                if (project.duplicates.length > 0) {
                    beforeText += `  ‚Ä¢ IDs duplicados: ${project.duplicates.map(d => d.id).join(', ')}\n`;
                }
                beforeText += `\n`;
            });

            beforeElement.textContent = beforeText;

            // Mostrar datos despu√©s
            let afterText = `üì§ DESPU√âS (${after.timestamp}):\n`;
            afterText += `‚Ä¢ Total tareas: ${after.totalTasks}\n`;
            afterText += `‚Ä¢ Proyectos: ${after.projectCount}\n`;
            afterText += `‚Ä¢ Duplicados totales: ${Object.values(after.projects).reduce((sum, p) => sum + p.duplicateCount, 0)}\n\n`;
            
            Object.entries(after.projects).forEach(([projectId, project]) => {
                afterText += `üìÅ ${projectId}:\n`;
                afterText += `  ‚Ä¢ Tareas: ${project.taskCount}\n`;
                afterText += `  ‚Ä¢ Duplicados: ${project.duplicateCount}\n`;
                if (project.duplicates.length > 0) {
                    afterText += `  ‚Ä¢ IDs duplicados: ${project.duplicates.map(d => d.id).join(', ')}\n`;
                }
                afterText += `\n`;
            });

            afterElement.textContent = afterText;

            // Detectar cambios
            const taskDifference = after.totalTasks - before.totalTasks;
            const duplicateDifference = Object.values(after.projects).reduce((sum, p) => sum + p.duplicateCount, 0) - 
                                      Object.values(before.projects).reduce((sum, p) => sum + p.duplicateCount, 0);

            if (taskDifference > 0) {
                afterElement.className = 'result error-result';
                afterElement.textContent += `\nüö® DUPLICACI√ìN DETECTADA: +${taskDifference} tareas`;
            } else if (duplicateDifference > 0) {
                afterElement.className = 'result warning-result';
                afterElement.textContent += `\n‚ö†Ô∏è DUPLICADOS AUMENTARON: +${duplicateDifference}`;
            } else {
                afterElement.className = 'result success-result';
                afterElement.textContent += `\n‚úÖ Sin duplicaci√≥n detectada`;
            }

            beforeAfterElement.style.display = 'grid';
        }

        // Funci√≥n para comparar antes/despu√©s
        function compareBeforeAfter() {
            if (!beforeSaveData) {
                alert('‚ö†Ô∏è Primero debes capturar datos "antes" del guardado');
                return;
            }

            const afterData = captureCurrentData();
            compareData(beforeSaveData, afterData);
        }

        // Funci√≥n para analizar patr√≥n de guardado
        function analyzeSavePattern() {
            const results = document.getElementById('results');
            results.className = 'result info-result';
            results.textContent = 'üìä Analizando patr√≥n de guardado...';

            try {
                const portfolioData = localStorage.getItem('mi-dashboard-portfolio');
                if (!portfolioData) {
                    results.className = 'result error-result';
                    results.textContent = '‚ùå No se encontraron datos en localStorage';
                    return;
                }

                const data = JSON.parse(portfolioData);
                const tasksByProject = data.tasksByProject || {};

                let reportText = `üìä AN√ÅLISIS DE PATR√ìN DE GUARDADO\n`;
                reportText += `===================================\n\n`;

                let totalTasks = 0;
                let totalDuplicates = 0;
                const suspiciousProjects = [];

                Object.entries(tasksByProject).forEach(([projectId, tasks]) => {
                    if (Array.isArray(tasks)) {
                        totalTasks += tasks.length;

                        // Detectar duplicados
                        const taskIds = new Set();
                        const duplicates = [];
                        tasks.forEach((task, index) => {
                            if (taskIds.has(task.id)) {
                                duplicates.push({ id: task.id, index, name: task.name });
                            } else {
                                taskIds.add(task.id);
                            }
                        });

                        totalDuplicates += duplicates.length;

                        if (duplicates.length > 0) {
                            suspiciousProjects.push({
                                projectId,
                                taskCount: tasks.length,
                                duplicateCount: duplicates.length,
                                duplicates
                            });
                        }

                        reportText += `üìÅ Proyecto ${projectId}:\n`;
                        reportText += `  ‚Ä¢ Tareas: ${tasks.length}\n`;
                        reportText += `  ‚Ä¢ Duplicados: ${duplicates.length}\n`;
                        
                        if (tasks.length > 100) {
                            reportText += `  ‚ö†Ô∏è PROYECTO GRANDE\n`;
                        }
                        
                        if (duplicates.length > 10) {
                            reportText += `  üö® MUCHOS DUPLICADOS\n`;
                        }
                        
                        reportText += `\n`;
                    }
                });

                reportText += `üìà RESUMEN:\n`;
                reportText += `‚Ä¢ Total tareas: ${totalTasks}\n`;
                reportText += `‚Ä¢ Total duplicados: ${totalDuplicates}\n`;
                reportText += `‚Ä¢ Proyectos sospechosos: ${suspiciousProjects.length}\n`;
                reportText += `‚Ä¢ Porcentaje duplicaci√≥n: ${totalTasks > 0 ? ((totalDuplicates / totalTasks) * 100).toFixed(2) : 0}%\n\n`;

                if (suspiciousProjects.length > 0) {
                    reportText += `üö® PROYECTOS CON PROBLEMAS:\n`;
                    suspiciousProjects.forEach(project => {
                        reportText += `‚Ä¢ ${project.projectId}: ${project.duplicateCount} duplicados de ${project.taskCount} tareas\n`;
                    });
                    reportText += `\n`;
                }

                reportText += `üîß RECOMENDACIONES:\n`;
                if (totalDuplicates > 50) {
                    reportText += `‚Ä¢ DUPLICACI√ìN MASIVA DETECTADA - Usar herramienta de limpieza\n`;
                }
                if (suspiciousProjects.length > 0) {
                    reportText += `‚Ä¢ Revisar proyectos espec√≠ficos con problemas\n`;
                }
                if (totalTasks > 500) {
                    reportText += `‚Ä¢ Proyecto muy grande - considerar divisi√≥n\n`;
                }

                results.textContent = reportText;
                results.className = totalDuplicates > 50 ? 'result error-result' : 
                                  totalDuplicates > 0 ? 'result warning-result' : 'result success-result';

            } catch (error) {
                results.className = 'result error-result';
                results.textContent = `‚ùå Error en an√°lisis: ${error.message}`;
            }
        }

        // Actualizar estad√≠sticas
        function updateStats() {
            const statsContainer = document.getElementById('stats');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${saveCount}</div>
                    <div class="stat-label">Guardados Detectados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${monitoringActive ? 'üéØ' : '‚èπÔ∏è'}</div>
                    <div class="stat-label">Estado Monitoreo</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${traceLog.length}</div>
                    <div class="stat-label">Eventos Registrados</div>
                </div>
            `;
        }

        // Actualizar estad√≠sticas cada segundo
        setInterval(updateStats, 1000);

        // Detener monitoreo al cerrar la p√°gina
        window.addEventListener('beforeunload', () => {
            stopMonitoring();
        });
    </script>
</body>
</html>
