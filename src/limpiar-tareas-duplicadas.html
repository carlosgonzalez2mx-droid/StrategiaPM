<!DOCTYPE html>
<html>
<head>
    <title>Limpiar Tareas Duplicadas</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h2>Limpiar Tareas Duplicadas en Supabase</h2>
    <p>Este script eliminar√° las tareas duplicadas, manteniendo solo la m√°s reciente de cada ID.</p>
    <button onclick="limpiarDuplicados()">Limpiar Duplicados</button>
    <div id="resultado"></div>

    <script>
        const supabaseUrl = 'https://ogqpsrsssrrytrqoyyph.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ncXBzcnNzc3JyeXRycW95eXBoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3Nzc5NjAsImV4cCI6MjA3MzM1Mzk2MH0.EqXjG1iefYMZ84Tw-4po98gBV7uRuPoz0idQgJ03pzg';

        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        async function limpiarDuplicados() {
            try {
                // 1. Cargar todos los proyectos
                const { data: projects, error: projectsError } = await supabase
                    .from('projects')
                    .select('id, name');

                if (projectsError) {
                    document.getElementById('resultado').innerHTML = `
                        <h3>Error cargando proyectos:</h3>
                        <pre>${JSON.stringify(projectsError, null, 2)}</pre>
                    `;
                    return;
                }

                let html = '<h3>üßπ Limpiando Tareas Duplicadas</h3>';
                let totalEliminadas = 0;

                // 2. Para cada proyecto, limpiar tareas duplicadas
                for (const project of projects) {
                    html += `<h4>üìã Proyecto: ${project.name}</h4>`;
                    
                    // Cargar todas las tareas del proyecto
                    const { data: tasks, error: tasksError } = await supabase
                        .from('tasks')
                        .select('*')
                        .eq('project_id', project.id)
                        .order('created_at', { ascending: false });

                    if (tasksError) {
                        html += `<p>‚ùå Error cargando tareas: ${tasksError.message}</p>`;
                        continue;
                    }

                    html += `<p>üìä Tareas encontradas: ${tasks.length}</p>`;

                    // Agrupar por ID de tarea
                    const tasksById = {};
                    tasks.forEach(task => {
                        if (!tasksById[task.id]) {
                            tasksById[task.id] = [];
                        }
                        tasksById[task.id].push(task);
                    });

                    // Identificar duplicados
                    const duplicados = Object.entries(tasksById).filter(([id, taskList]) => taskList.length > 1);
                    
                    if (duplicados.length === 0) {
                        html += `<p>‚úÖ No hay duplicados en este proyecto</p>`;
                        continue;
                    }

                    html += `<p>‚ö†Ô∏è Duplicados encontrados: ${duplicados.length}</p>`;

                    // Eliminar duplicados (mantener solo el m√°s reciente)
                    for (const [taskId, taskList] of duplicados) {
                        // Ordenar por created_at descendente (m√°s reciente primero)
                        taskList.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                        
                        // Mantener el primero (m√°s reciente) y eliminar el resto
                        const tareaAMantener = taskList[0];
                        const tareasAEliminar = taskList.slice(1);

                        html += `<p>üîÑ Tarea "${tareaAMantener.name}" (ID: ${taskId}):</p>`;
                        html += `<ul>`;
                        html += `<li>‚úÖ Manteniendo: ${tareaAMantener.created_at}</li>`;

                        for (const tarea of tareasAEliminar) {
                            try {
                                const { error: deleteError } = await supabase
                                    .from('tasks')
                                    .delete()
                                    .eq('id', tarea.id);

                                if (deleteError) {
                                    html += `<li>‚ùå Error eliminando ${tarea.created_at}: ${deleteError.message}</li>`;
                                } else {
                                    html += `<li>üóëÔ∏è Eliminada: ${tarea.created_at}</li>`;
                                    totalEliminadas++;
                                }
                            } catch (err) {
                                html += `<li>‚ùå Error eliminando ${tarea.created_at}: ${err.message}</li>`;
                            }
                        }
                        html += `</ul>`;
                    }
                }

                html += `<h3>üéâ Limpieza Completada</h3>`;
                html += `<p><strong>Total de tareas duplicadas eliminadas:</strong> ${totalEliminadas}</p>`;

                document.getElementById('resultado').innerHTML = html;

            } catch (err) {
                document.getElementById('resultado').innerHTML = `
                    <h3>Error general:</h3>
                    <p>${err.message}</p>
                `;
            }
        }
    </script>
</body>
</html>
