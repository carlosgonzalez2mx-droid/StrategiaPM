<!DOCTYPE html>
<html>
<head>
    <title>Regenerar Tareas con UUIDs V√°lidos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h2>Regenerar Tareas con UUIDs V√°lidos</h2>
    <p><strong>‚ö†Ô∏è ADVERTENCIA:</strong> Este script eliminar√° TODAS las tareas de Supabase y las recrear√° con UUIDs v√°lidos.</p>
    <button onclick="regenerarTareas()" style="background-color: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 5px;">REGENERAR TAREAS</button>
    <div id="resultado"></div>

    <script>
        const supabaseUrl = 'https://ogqpsrsssrrytrqoyyph.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ncXBzcnNzc3JyeXRycW95eXBoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3Nzc5NjAsImV4cCI6MjA3MzM1Mzk2MH0.EqXjG1iefYMZ84Tw-4po98gBV7uRuPoz0idQgJ03pzg';

        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // Funci√≥n para generar UUID v√°lido
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Funci√≥n para limpiar dependencias circulares
        function cleanCircularDependencies(tasks) {
            const taskMap = new Map();
            const cleanedTasks = [];
            
            // Crear mapa de tareas
            tasks.forEach(task => {
                taskMap.set(task.id, {
                    ...task,
                    predecessors: [...(task.predecessors || [])],
                    successors: [...(task.successors || [])]
                });
            });
            
            // Detectar y limpiar dependencias circulares
            const visited = new Set();
            const recStack = new Set();
            const circularTasks = new Set();
            
            const hasCycle = (taskId) => {
                if (recStack.has(taskId)) {
                    circularTasks.add(taskId);
                    return true;
                }
                if (visited.has(taskId)) return false;
                
                visited.add(taskId);
                recStack.add(taskId);
                
                const task = taskMap.get(taskId);
                if (task && task.predecessors) {
                    for (const predId of task.predecessors) {
                        if (hasCycle(predId)) {
                            circularTasks.add(taskId);
                            return true;
                        }
                    }
                }
                
                recStack.delete(taskId);
                return false;
            };
            
            // Detectar ciclos
            for (const taskId of taskMap.keys()) {
                if (!visited.has(taskId)) {
                    hasCycle(taskId);
                }
            }
            
            // Limpiar dependencias circulares
            for (const taskId of circularTasks) {
                const task = taskMap.get(taskId);
                if (task) {
                    task.predecessors = [];
                    task.successors = [];
                }
            }
            
            return Array.from(taskMap.values());
        }

        async function regenerarTareas() {
            if (!confirm('¬øEst√°s seguro? Esto eliminar√° TODAS las tareas de Supabase y las recrear√° con UUIDs v√°lidos.')) {
                return;
            }

            try {
                let html = '<h3>üîÑ Regenerando tareas con UUIDs v√°lidos</h3>';
                
                // 1. Eliminar TODAS las tareas
                html += '<h4>üóëÔ∏è Eliminando todas las tareas...</h4>';
                const { error: deleteError } = await supabase
                    .from('tasks')
                    .delete()
                    .neq('id', '00000000-0000-0000-0000-000000000000');

                if (deleteError) {
                    html += `<p>‚ùå Error eliminando tareas: ${deleteError.message}</p>`;
                    document.getElementById('resultado').innerHTML = html;
                    return;
                }

                html += '<p>‚úÖ Todas las tareas eliminadas</p>';

                // 2. Cargar proyectos
                const { data: projects, error: projectsError } = await supabase
                    .from('projects')
                    .select('id, name');

                if (projectsError) {
                    html += `<p>‚ùå Error cargando proyectos: ${projectsError.message}</p>`;
                    document.getElementById('resultado').innerHTML = html;
                    return;
                }

                html += `<h4>üìã Proyectos encontrados: ${projects.length}</h4>`;

                // 3. Para cada proyecto, regenerar tareas
                for (const project of projects) {
                    html += `<h5>üîÑ Procesando proyecto: ${project.name}</h5>`;
                    
                    // Cargar datos locales
                    const localData = localStorage.getItem('portfolioData');
                    if (!localData) {
                        html += `<p>‚ö†Ô∏è No hay datos locales para ${project.name}</p>`;
                        continue;
                    }

                    try {
                        const parsed = JSON.parse(localData);
                        const projectTasks = parsed.tasksByProject?.[project.id] || [];
                        
                        if (projectTasks.length === 0) {
                            html += `<p>‚ÑπÔ∏è No hay tareas locales para ${project.name}</p>`;
                            continue;
                        }

                        // Limpiar dependencias circulares
                        const cleanedTasks = cleanCircularDependencies(projectTasks);
                        html += `<p>üîß Dependencias circulares limpiadas: ${projectTasks.length - cleanedTasks.length}</p>`;

                        // Eliminar duplicados por nombre y contenido
                        const uniqueTasks = [];
                        const seenContent = new Set();
                        let duplicatesRemoved = 0;

                        for (const task of cleanedTasks) {
                            const contentKey = `${task.name}-${task.duration}-${task.startDate}-${task.endDate}`;
                            if (seenContent.has(contentKey)) {
                                duplicatesRemoved++;
                            } else {
                                seenContent.add(contentKey);
                                uniqueTasks.push(task);
                            }
                        }

                        html += `<p>üìä Tareas originales: ${projectTasks.length}, √∫nicas: ${uniqueTasks.length}, duplicados eliminados: ${duplicatesRemoved}</p>`;

                        // Regenerar con UUIDs v√°lidos
                        if (uniqueTasks.length > 0) {
                            const tasksToInsert = uniqueTasks.map(task => ({
                                id: generateUUID(), // Nuevo UUID v√°lido
                                name: task.name,
                                description: task.description || '',
                                duration: task.duration || 0,
                                progress: task.progress || 0,
                                priority: task.priority || 'medium',
                                cost: task.cost || 0,
                                predecessors: [], // Limpiar dependencias problem√°ticas
                                successors: [], // Limpiar dependencias problem√°ticas
                                resources: task.resources || [],
                                status: task.status || 'pending',
                                project_id: project.id,
                                owner_id: '00000000-0000-0000-0000-000000000000',
                                wbs_code: task.wbsCode || task.wbs_code || '',
                                start_date: task.startDate || task.start_date,
                                end_date: task.endDate || task.end_date,
                                assigned_to: task.assignedTo || task.assigned_to || '',
                                is_milestone: task.isMilestone || task.is_milestone || false,
                                original_duration: task.originalDuration || task.original_duration || task.duration
                            }));

                            const { error: insertError } = await supabase
                                .from('tasks')
                                .insert(tasksToInsert);

                            if (insertError) {
                                html += `<p>‚ùå Error insertando tareas para ${project.name}: ${insertError.message}</p>`;
                            } else {
                                html += `<p>‚úÖ ${uniqueTasks.length} tareas regeneradas para ${project.name}</p>`;
                            }
                        }

                    } catch (parseError) {
                        html += `<p>‚ùå Error parseando datos locales: ${parseError.message}</p>`;
                    }
                }

                html += '<h3>üéâ Regeneraci√≥n Completada</h3>';
                html += '<p><strong>Recomendaci√≥n:</strong> Recarga tu aplicaci√≥n para ver los cambios.</p>';

                document.getElementById('resultado').innerHTML = html;

            } catch (err) {
                document.getElementById('resultado').innerHTML = `
                    <h3>Error general:</h3>
                    <p>${err.message}</p>
                `;
            }
        }
    </script>
</body>
</html>
