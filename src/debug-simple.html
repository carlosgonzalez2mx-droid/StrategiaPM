<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Simple Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Debug Simple Supabase</h1>
    <button onclick="debug()">Ejecutar Debug</button>
    <div id="output"></div>

    <script>
        const supabase = window.supabase.createClient(
            'https://ogqpsrsssrrytrqoyyph.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ncXBzcnNzc3JyeXRycW95eXBoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc3Nzc5NjAsImV4cCI6MjA3MzM1Mzk2MH0.EqXjG1iefYMZ84Tw-4po98gBV7uRuPoz0idQgJ03pzg'
        );

        async function debug() {
            const output = document.getElementById('output');
            output.innerHTML = '';

            try {
                // 1. Verificar usuario
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (userError) {
                    output.innerHTML += `<p>❌ Error usuario: ${userError.message}</p>`;
                    return;
                }
                output.innerHTML += `<p>✅ Usuario: ${user.email} (${user.id})</p>`;

                // 2. Buscar organizaciones del usuario
                const { data: orgs, error: orgError } = await supabase
                    .from('organizations')
                    .select('*')
                    .eq('owner_id', user.id);
                
                if (orgError) {
                    output.innerHTML += `<p>❌ Error organizaciones: ${orgError.message}</p>`;
                } else {
                    output.innerHTML += `<p>✅ Organizaciones encontradas: ${orgs.length}</p>`;
                    orgs.forEach(org => {
                        output.innerHTML += `<p>  - ${org.name} (${org.id})</p>`;
                    });
                }

                // 3. Intentar obtener TODOS los proyectos (sin filtro)
                const { data: allProjects, error: allError } = await supabase
                    .from('projects')
                    .select('*');
                
                if (allError) {
                    output.innerHTML += `<p>❌ Error todos los proyectos: ${allError.message} (${allError.code})</p>`;
                } else {
                    output.innerHTML += `<p>✅ Todos los proyectos: ${allProjects.length}</p>`;
                    allProjects.forEach(project => {
                        output.innerHTML += `<p>  - ${project.name} (Org: ${project.organization_id})</p>`;
                    });
                }

                // 4. Si hay organizaciones, intentar proyectos de la primera
                if (orgs.length > 0) {
                    const orgId = orgs[0].id;
                    const { data: orgProjects, error: orgProjError } = await supabase
                        .from('projects')
                        .select('*')
                        .eq('organization_id', orgId);
                    
                    if (orgProjError) {
                        output.innerHTML += `<p>❌ Error proyectos de org: ${orgProjError.message} (${orgProjError.code})</p>`;
                    } else {
                        output.innerHTML += `<p>✅ Proyectos de la organización: ${orgProjects.length}</p>`;
                        orgProjects.forEach(project => {
                            output.innerHTML += `<p>  - ${project.name} (${project.id})</p>`;
                        });
                    }
                }

            } catch (error) {
                output.innerHTML += `<p>❌ Error inesperado: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
