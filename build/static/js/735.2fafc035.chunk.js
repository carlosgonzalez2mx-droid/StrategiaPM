"use strict";(self.webpackChunkmi_dashboard=self.webpackChunkmi_dashboard||[]).push([[735],{3116:(e,o,a)=>{a.d(o,{A:()=>n});var r=a(9379),t=a(9950),l=a(9874);const i=()=>{const[e,o]=(0,t.useState)("local"),[a,r]=(0,t.useState)(!1),[i,c]=(0,t.useState)(!0);(0,t.useEffect)(()=>{s()},[]);const s=(0,t.useCallback)(async()=>{c(!0);try{if(l.default.isAuthenticated()){console.log("\ud83d\udd0d Verificando disponibilidad de Supabase Storage...");const e=await l.default.initializeStorage();r(e),o(e?"supabase":"local"),console.log("\u2705 Storage provider configurado: ".concat(e?"Supabase":"Local"))}else console.log("\u26a0\ufe0f Usuario no autenticado, usando almacenamiento local"),r(!1),o("local")}catch(e){console.error("\u274c Error verificando Supabase:",e),console.log("\ud83d\udd04 Fallback a localStorage debido a error de Supabase"),r(!1),o("local")}finally{c(!1)}},[]),n=(0,t.useCallback)(async e=>"supabase"!==e||a?(console.log("\ud83d\udd04 Cambiando proveedor de almacenamiento a: ".concat(e)),o(e),!0):(console.warn("\u26a0\ufe0f No se puede cambiar a Supabase: no est\xe1 disponible"),!1),[a]),d=(0,t.useCallback)(()=>a&&"supabase"===e,[a,e]);return{storageProvider:e,isSupabaseAvailable:a,isCheckingSupabase:i,checkSupabaseAvailability:s,switchStorageProvider:n,shouldUseSupabase:d}},c={maxFileSize:10485760,maxFilesPerProject:100,maxTotalSizePerProject:524288e3,allowedTypes:["pdf","jpg","jpeg","png","doc","docx","xls","xlsx"],allowedMimeTypes:["application/pdf","image/jpeg","image/jpg","image/png","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"]},s=()=>{const e=(0,t.useCallback)(e=>{if(e.size>c.maxFileSize)throw new Error("El archivo es demasiado grande. M\xe1ximo ".concat(c.maxFileSize/1048576,"MB"));const o=e.name.split(".").pop().toLowerCase();if(!c.allowedTypes.includes(o))throw new Error("Tipo de archivo no permitido. Tipos permitidos: ".concat(c.allowedTypes.join(", ")));if(!c.allowedMimeTypes.includes(e.type))throw new Error("Tipo de archivo no v\xe1lido");return!0},[]),o=(0,t.useCallback)((e,o)=>{if(e.length>=c.maxFilesPerProject)throw new Error("L\xedmite de archivos alcanzado. M\xe1ximo ".concat(c.maxFilesPerProject," archivos por proyecto"));if(e.reduce((e,o)=>e+(o.fileSize||0),0)+o.size>c.maxTotalSizePerProject)throw new Error("L\xedmite de tama\xf1o alcanzado. M\xe1ximo ".concat(c.maxTotalSizePerProject/1048576,"MB por proyecto"))},[]),a=(0,t.useCallback)(async e=>e.type.startsWith("image/")?new Promise(o=>{const a=document.createElement("canvas"),r=a.getContext("2d"),t=new Image;t.onload=()=>{const l=1200;let{width:i,height:c}=t;i>c&&i>l?(c=c*l/i,i=l):c>l&&(i=i*l/c,c=l),a.width=i,a.height=c,r.drawImage(t,0,0,i,c),a.toBlob(a=>{const r=new File([a],e.name,{type:e.type,lastModified:Date.now()});console.log("\ud83d\uddbc\ufe0f Imagen comprimida: ".concat((e.size/1024).toFixed(2),"KB \u2192 ").concat((r.size/1024).toFixed(2),"KB")),o(r)},e.type,.8)},t.onerror=()=>{console.warn("\u26a0\ufe0f Error comprimiendo imagen, usando archivo original"),o(e)},t.src=URL.createObjectURL(e)}):e,[]),r=(0,t.useCallback)(e=>new Promise((o,a)=>{const r=new FileReader;r.readAsDataURL(e),r.onload=()=>o(r.result),r.onerror=e=>a(e)}),[]),l=(0,t.useCallback)(async function(r){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];e(r),o(t,r);return await a(r)},[e,o,a]);return{validateFile:e,validateProjectLimits:o,compressImage:a,fileToBase64:r,validateAndProcessFile:l,FILE_LIMITS:c}},n=e=>{const[o,a]=(0,t.useState)([]),[n,d]=(0,t.useState)(!1),[u,p]=(0,t.useState)(null),{storageProvider:g,isSupabaseAvailable:m,switchStorageProvider:f,shouldUseSupabase:h}=i(),{validateAndProcessFile:S,fileToBase64:v,FILE_LIMITS:b}=s();(0,t.useEffect)(()=>{e&&C()},[e,g,m]);const y=(0,t.useCallback)(()=>{try{const o="project-files-".concat(e),r=localStorage.getItem(o);if(r){const e=JSON.parse(r);a(Array.isArray(e)?e:[]),console.log("\ud83d\udcc2 ".concat(e.length," archivos cargados desde localStorage"))}else a([])}catch(u){console.error("\u274c Error cargando desde localStorage:",u),a([])}},[e]),w=(0,t.useCallback)(o=>{try{const a="project-files-".concat(e);localStorage.setItem(a,JSON.stringify(o)),console.log("\ud83d\udcbe ".concat(o.length," archivos guardados en localStorage"))}catch(u){console.error("\u274c Error guardando en localStorage:",u)}},[e]),C=(0,t.useCallback)(async()=>{if(e){d(!0),p(null);try{if(h()){console.log("\ud83d\udcc2 Cargando archivos desde Supabase para proyecto ".concat(e,"..."));const{success:o,files:t,error:i}=await l.default.listProjectFiles(e);if(o){const e=t.map(e=>{var o,a,t,l;return(0,r.A)((0,r.A)({},e),{},{mimeType:(null===(o=e.metadata)||void 0===o?void 0:o.mimeType)||"application/octet-stream",description:(null===(a=e.metadata)||void 0===a?void 0:a.description)||"",relatedItemId:(null===(t=e.metadata)||void 0===t?void 0:t.relatedItemId)||null,content:e.publicUrl,fileExtension:(null===(l=e.fileName.split(".").pop())||void 0===l?void 0:l.toLowerCase())||""})});a(e),console.log("\u2705 ".concat(e.length," archivos cargados desde Supabase"))}else console.error("\u274c Error cargando desde Supabase:",i),y()}else y()}catch(u){console.error("\u274c Error cargando archivos:",u),p("Error al cargar archivos del proyecto"),y()}finally{d(!1)}}},[e,h,y]),E=(0,t.useCallback)(async function(t,i,c){let s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";d(!0),p(null);try{const d=await S(t,o);let u;if(h()){var n;console.log("\u2601\ufe0f Subiendo archivo a Supabase Storage...");const p={description:s,relatedItemId:c,originalName:t.name,uploadedBy:(null===(n=l.default.getCurrentUser())||void 0===n?void 0:n.email)||"Usuario",mimeType:t.type},f=await l.default.uploadFileToStorage(d,e,i,p);var g;if(!f.success)throw new Error("Error subiendo a Supabase: ".concat((null===(g=f.error)||void 0===g?void 0:g.message)||"Error desconocido"));{var m;u=(0,r.A)((0,r.A)({},f.file),{},{description:s,relatedItemId:c,fileExtension:t.name.split(".").pop().toLowerCase(),uploadedBy:(null===(m=l.default.getCurrentUser())||void 0===m?void 0:m.email)||"Usuario Actual"});const e=[...o,u];a(e),console.log("\u2705 Archivo subido exitosamente a Supabase Storage:",u.fileName)}}else{console.log("\ud83d\udcbe Subiendo archivo a localStorage...");const r=await v(d);u={id:"file-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),projectId:e,category:i,relatedItemId:c,fileName:t.name,originalName:t.name,fileSize:d.size,mimeType:t.type,uploadDate:(new Date).toISOString(),uploadedBy:"Usuario Actual",description:s,content:r,fileExtension:t.name.split(".").pop().toLowerCase(),metadata:{storageProvider:"local"}};const l=[...o,u];a(l),w(l),console.log("\u2705 Archivo subido exitosamente a localStorage:",u.fileName)}return u}catch(u){throw console.error("Error uploading file:",u),p(u.message),u}finally{d(!1)}},[o,e,S,v,w,h]),F=(0,t.useCallback)(async e=>{try{const r=o.find(o=>o.id===e);if(!r)throw new Error("Archivo no encontrado");if(h()&&r.storagePath){console.log("\ud83d\uddd1\ufe0f Eliminando archivo de Supabase Storage...");const e=await l.default.deleteFileFromStorage(r.storagePath);e.success?console.log("\u2705 Archivo eliminado de Supabase Storage"):console.warn("\u26a0\ufe0f Error eliminando archivo de Supabase Storage:",e.error)}const t=o.filter(o=>o.id!==e);a(t),"local"===g&&w(t),console.log("\u2705 Archivo eliminado exitosamente:",e)}catch(u){console.error("Error deleting file:",u),p("Error al eliminar archivo")}},[o,w,h,g]),I=(0,t.useCallback)(e=>"financial-only"===e?o.filter(e=>"contract"===e.category||"invoice"===e.category||"financial"===e.category):o.filter(o=>o.category===e),[o]),P=(0,t.useCallback)(e=>o.filter(o=>o.relatedItemId===e),[o]),x=(0,t.useCallback)(e=>{if(!e)return o;const a=e.toLowerCase();return o.filter(e=>{var o,r;return e.fileName.toLowerCase().includes(a)||(null===(o=e.description)||void 0===o?void 0:o.toLowerCase().includes(a))||(null===(r=e.category)||void 0===r?void 0:r.toLowerCase().includes(a))})},[o]),k=(0,t.useCallback)(()=>{const e=o.reduce((e,o)=>e+(o.fileSize||0),0),a=o.reduce((e,o)=>(e[o.category]=(e[o.category]||0)+1,e),{});return{totalFiles:o.length,totalSize:e,totalSizeMB:(e/1048576).toFixed(2),filesByCategory:a,percentageUsed:(e/c.maxTotalSizePerProject*100).toFixed(1)}},[o]),z=(0,t.useCallback)(()=>{a([]);const o="project-files-".concat(e);localStorage.removeItem(o),console.log("\ud83d\uddd1\ufe0f Archivos del proyecto limpiados")},[e]),A=(0,t.useCallback)(async e=>{const o=await f(e);return o&&await C(),o},[f,C]),T=(0,t.useCallback)(async()=>{if(!m)return console.warn("\u26a0\ufe0f Supabase no est\xe1 disponible"),!1;try{console.log("\ud83d\udd04 Iniciando sincronizaci\xf3n con Supabase...");const o="project-files-".concat(e),a=localStorage.getItem(o),r=a?JSON.parse(a):[];if(0===r.length)return console.log("\ud83d\udcc2 No hay archivos locales para sincronizar"),!0;console.log("\ud83d\udce4 Sincronizando ".concat(r.length," archivos con Supabase..."));for(const e of r)if(!e.storagePath&&e.content)try{const o=e.content.split(",")[1],a=atob(o),r=new Array(a.length);for(let e=0;e<a.length;e++)r[e]=a.charCodeAt(e);const t=new Uint8Array(r),l=new Blob([t],{type:e.mimeType}),i=new File([l],e.fileName,{type:e.mimeType});await E(i,e.category,e.relatedItemId,e.description)}catch(u){console.error("\u274c Error sincronizando archivo ".concat(e.fileName,":"),u)}return console.log("\u2705 Sincronizaci\xf3n completada"),!0}catch(u){return console.error("\u274c Error en sincronizaci\xf3n:",u),!1}},[e,m,E]);return{files:o,isLoading:n,error:u,storageProvider:g,isSupabaseAvailable:m,uploadFile:E,deleteFile:F,loadProjectFiles:C,getFilesByCategory:I,getFilesByRelatedItem:P,searchFiles:x,getFileStats:k,clearProjectFiles:z,switchStorageProvider:A,syncWithSupabase:T,fileLimits:b}}}}]);