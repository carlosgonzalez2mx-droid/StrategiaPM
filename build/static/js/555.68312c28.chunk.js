"use strict";(self.webpackChunkmi_dashboard=self.webpackChunkmi_dashboard||[]).push([[555],{9555:(e,a,o)=>{o.d(a,{A:()=>s});var t=o(9379),r=o(5043),i=o(2416);const l=()=>{const[e,a]=(0,r.useState)("local"),[o,t]=(0,r.useState)(!1),[l,n]=(0,r.useState)(!0);(0,r.useEffect)(()=>{c()},[]);const c=(0,r.useCallback)(async()=>{n(!0);try{if(i.default.isAuthenticated()){console.log("\ud83d\udd0d Verificando disponibilidad de Supabase Storage...");const e=await i.default.initializeStorage();t(e),a(e?"supabase":"local"),console.log("\u2705 Storage provider configurado: ".concat(e?"Supabase":"Local"))}else console.log("\u26a0\ufe0f Usuario no autenticado, usando almacenamiento local"),t(!1),a("local")}catch(e){console.error("\u274c Error verificando Supabase:",e),console.log("\ud83d\udd04 Fallback a localStorage debido a error de Supabase"),t(!1),a("local")}finally{n(!1)}},[]),s=(0,r.useCallback)(async e=>"supabase"!==e||o?(console.log("\ud83d\udd04 Cambiando proveedor de almacenamiento a: ".concat(e)),a(e),!0):(console.warn("\u26a0\ufe0f No se puede cambiar a Supabase: no est\xe1 disponible"),!1),[o]),d=(0,r.useCallback)(()=>o&&"supabase"===e,[o,e]);return{storageProvider:e,isSupabaseAvailable:o,isCheckingSupabase:l,checkSupabaseAvailability:c,switchStorageProvider:s,shouldUseSupabase:d}},n={maxFileSize:10485760,maxFilesPerProject:100,maxTotalSizePerProject:524288e3,allowedTypes:["pdf","jpg","jpeg","png","doc","docx","xls","xlsx"],allowedMimeTypes:["application/pdf","image/jpeg","image/jpg","image/png","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"]},c=()=>{const e=(0,r.useCallback)(e=>{if(e.size>n.maxFileSize)throw new Error("El archivo es demasiado grande. M\xe1ximo ".concat(n.maxFileSize/1048576,"MB"));const a=e.name.split(".").pop().toLowerCase();if(!n.allowedTypes.includes(a))throw new Error("Tipo de archivo no permitido. Tipos permitidos: ".concat(n.allowedTypes.join(", ")));if(!n.allowedMimeTypes.includes(e.type))throw new Error("Tipo de archivo no v\xe1lido");return!0},[]),a=(0,r.useCallback)((e,a)=>{if(e.length>=n.maxFilesPerProject)throw new Error("L\xedmite de archivos alcanzado. M\xe1ximo ".concat(n.maxFilesPerProject," archivos por proyecto"));if(e.reduce((e,a)=>e+(a.fileSize||0),0)+a.size>n.maxTotalSizePerProject)throw new Error("L\xedmite de tama\xf1o alcanzado. M\xe1ximo ".concat(n.maxTotalSizePerProject/1048576,"MB por proyecto"))},[]),o=(0,r.useCallback)(async e=>e.type.startsWith("image/")?new Promise(a=>{const o=document.createElement("canvas"),t=o.getContext("2d"),r=new Image;r.onload=()=>{const i=1200;let{width:l,height:n}=r;l>n&&l>i?(n=n*i/l,l=i):n>i&&(l=l*i/n,n=i),o.width=l,o.height=n,t.drawImage(r,0,0,l,n),o.toBlob(o=>{const t=new File([o],e.name,{type:e.type,lastModified:Date.now()});console.log("\ud83d\uddbc\ufe0f Imagen comprimida: ".concat((e.size/1024).toFixed(2),"KB \u2192 ").concat((t.size/1024).toFixed(2),"KB")),a(t)},e.type,.8)},r.onerror=()=>{console.warn("\u26a0\ufe0f Error comprimiendo imagen, usando archivo original"),a(e)},r.src=URL.createObjectURL(e)}):e,[]),t=(0,r.useCallback)(e=>new Promise((a,o)=>{const t=new FileReader;t.readAsDataURL(e),t.onload=()=>a(t.result),t.onerror=e=>o(e)}),[]),i=(0,r.useCallback)(async function(t){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];e(t),a(r,t);return await o(t)},[e,a,o]);return{validateFile:e,validateProjectLimits:a,compressImage:o,fileToBase64:t,validateAndProcessFile:i,FILE_LIMITS:n}},s=e=>{const[a,o]=(0,r.useState)([]),[s,d]=(0,r.useState)(!1),[m,g]=(0,r.useState)(null),{storageProvider:u,isSupabaseAvailable:p,switchStorageProvider:f,shouldUseSupabase:h}=l(),{validateAndProcessFile:S,fileToBase64:v,FILE_LIMITS:b}=c();(0,r.useEffect)(()=>{e&&N()},[e,u,p]);const y=(0,r.useCallback)(()=>{try{const a="project-files-".concat(e),r=localStorage.getItem(a);if(r){const e=JSON.parse(r),i=e.map(e=>{var a;if(null!==(a=e.metadata)&&void 0!==a&&a.originalName&&e.fileName!==e.metadata.originalName)return console.log("\ud83d\udd04 Migrando desde metadata: ".concat(e.fileName," \u2192 ").concat(e.metadata.originalName)),(0,t.A)((0,t.A)({},e),{},{fileName:e.metadata.originalName,originalName:e.metadata.originalName});if(e.originalName&&e.fileName!==e.originalName)return console.log("\ud83d\udd04 Corrigiendo con originalName: ".concat(e.fileName," \u2192 ").concat(e.originalName)),(0,t.A)((0,t.A)({},e),{},{fileName:e.originalName});if(e.storagePath){const a=e.storagePath.split("/"),o=a[a.length-1].match(/^\d+-(.+)$/);if(o&&o[1]!==e.fileName)return console.log("\ud83d\udd04 Extrayendo de storagePath: ".concat(e.fileName," \u2192 ").concat(o[1])),(0,t.A)((0,t.A)({},e),{},{fileName:o[1],originalName:o[1]})}return e});o(Array.isArray(i)?i:[]),JSON.stringify(e)!==JSON.stringify(i)&&(localStorage.setItem(a,JSON.stringify(i)),console.log("\u2728 Nombres de archivos migrados autom\xe1ticamente")),console.log("\ud83d\udcc2 ".concat(i.length," archivos cargados desde localStorage"))}else o([])}catch(m){console.error("\u274c Error cargando desde localStorage:",m),o([])}},[e]),w=(0,r.useCallback)(a=>{try{const o="project-files-".concat(e);localStorage.setItem(o,JSON.stringify(a)),console.log("\ud83d\udcbe ".concat(a.length," archivos guardados en localStorage"))}catch(m){console.error("\u274c Error guardando en localStorage:",m)}},[e]),N=(0,r.useCallback)(async()=>{if(e){d(!0),g(null);try{if(h()){console.log("\ud83d\udcc2 Cargando archivos desde Supabase para proyecto ".concat(e,"..."));const{success:a,files:r,error:l}=await i.default.listProjectFiles(e);if(a){const e=r.map(e=>{var a,o,r,i,l;let n=e.fileName;if(e.storagePath&&/^\d+-[a-z0-9]+\.[a-z]+$/i.test(e.fileName)){const a=e.storagePath.split("/"),o=a[a.length-1].match(/^\d+-(.+)$/);o&&(n=o[1])}return null!==(a=e.metadata)&&void 0!==a&&a.originalName&&(n=e.metadata.originalName),(0,t.A)((0,t.A)({},e),{},{fileName:n,originalName:n,mimeType:(null===(o=e.metadata)||void 0===o?void 0:o.mimeType)||"application/octet-stream",description:(null===(r=e.metadata)||void 0===r?void 0:r.description)||"",relatedItemId:(null===(i=e.metadata)||void 0===i?void 0:i.relatedItemId)||null,content:e.publicUrl,fileExtension:(null===(l=n.split(".").pop())||void 0===l?void 0:l.toLowerCase())||""})});o(e),console.log("\u2705 ".concat(e.length," archivos cargados desde Supabase"))}else console.error("\u274c Error cargando desde Supabase:",l),y()}else y()}catch(m){console.error("\u274c Error cargando archivos:",m),g("Error al cargar archivos del proyecto"),y()}finally{d(!1)}}},[e,h,y]),C=(0,r.useCallback)(async function(r,l,n){let c=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";d(!0),g(null);try{const d=await S(r,a);let m;if(h()){var s;console.log("\u2601\ufe0f Subiendo archivo a Supabase Storage...");const g={description:c,relatedItemId:n,originalName:r.name,uploadedBy:(null===(s=i.default.getCurrentUser())||void 0===s?void 0:s.email)||"Usuario",mimeType:r.type},f=await i.default.uploadFileToStorage(d,e,l,g);var u;if(!f.success)throw new Error("Error subiendo a Supabase: ".concat((null===(u=f.error)||void 0===u?void 0:u.message)||"Error desconocido"));{var p;m=(0,t.A)((0,t.A)({},f.file),{},{description:c,relatedItemId:n,fileExtension:r.name.split(".").pop().toLowerCase(),uploadedBy:(null===(p=i.default.getCurrentUser())||void 0===p?void 0:p.email)||"Usuario Actual"});const e=[...a,m];o(e),console.log("\u2705 Archivo subido exitosamente a Supabase Storage:",m.fileName)}}else{console.log("\ud83d\udcbe Subiendo archivo a localStorage...");const t=await v(d);m={id:"file-".concat(Date.now(),"-").concat(Math.random().toString(36).substr(2,9)),projectId:e,category:l,relatedItemId:n,fileName:r.name,originalName:r.name,fileSize:d.size,mimeType:r.type,uploadDate:(new Date).toISOString(),uploadedBy:"Usuario Actual",description:c,content:t,fileExtension:r.name.split(".").pop().toLowerCase(),metadata:{storageProvider:"local"}};const i=[...a,m];o(i),w(i),console.log("\u2705 Archivo subido exitosamente a localStorage:",m.fileName)}return m}catch(m){throw console.error("Error uploading file:",m),g(m.message),m}finally{d(!1)}},[a,e,S,v,w,h]),P=(0,r.useCallback)(async e=>{try{const t=a.find(a=>a.id===e);if(!t)throw new Error("Archivo no encontrado");if(h()&&t.storagePath){console.log("\ud83d\uddd1\ufe0f Eliminando archivo de Supabase Storage...");const e=await i.default.deleteFileFromStorage(t.storagePath);e.success?console.log("\u2705 Archivo eliminado de Supabase Storage"):console.warn("\u26a0\ufe0f Error eliminando archivo de Supabase Storage:",e.error)}const r=a.filter(a=>a.id!==e);o(r),"local"===u&&w(r),console.log("\u2705 Archivo eliminado exitosamente:",e)}catch(m){console.error("Error deleting file:",m),g("Error al eliminar archivo")}},[a,w,h,u]),E=(0,r.useCallback)(e=>"financial-only"===e?a.filter(e=>"contract"===e.category||"invoice"===e.category||"financial"===e.category):a.filter(a=>a.category===e),[a]),I=(0,r.useCallback)(e=>a.filter(a=>a.relatedItemId===e),[a]),x=(0,r.useCallback)(e=>{if(!e)return a;const o=e.toLowerCase();return a.filter(e=>{var a,t;return e.fileName.toLowerCase().includes(o)||(null===(a=e.description)||void 0===a?void 0:a.toLowerCase().includes(o))||(null===(t=e.category)||void 0===t?void 0:t.toLowerCase().includes(o))})},[a]),A=(0,r.useCallback)(()=>{const e=a.reduce((e,a)=>e+(a.fileSize||0),0),o=a.reduce((e,a)=>(e[a.category]=(e[a.category]||0)+1,e),{});return{totalFiles:a.length,totalSize:e,totalSizeMB:(e/1048576).toFixed(2),filesByCategory:o,percentageUsed:(e/n.maxTotalSizePerProject*100).toFixed(1)}},[a]),F=(0,r.useCallback)(()=>{o([]);const a="project-files-".concat(e);localStorage.removeItem(a),console.log("\ud83d\uddd1\ufe0f Archivos del proyecto limpiados")},[e]),z=(0,r.useCallback)(async e=>{const a=await f(e);return a&&await N(),a},[f,N]),k=(0,r.useCallback)(async()=>{if(!p)return console.warn("\u26a0\ufe0f Supabase no est\xe1 disponible"),!1;try{console.log("\ud83d\udd04 Iniciando sincronizaci\xf3n con Supabase...");const a="project-files-".concat(e),o=localStorage.getItem(a),t=o?JSON.parse(o):[];if(0===t.length)return console.log("\ud83d\udcc2 No hay archivos locales para sincronizar"),!0;console.log("\ud83d\udce4 Sincronizando ".concat(t.length," archivos con Supabase..."));for(const e of t)if(!e.storagePath&&e.content)try{const a=e.content.split(",")[1],o=atob(a),t=new Array(o.length);for(let e=0;e<o.length;e++)t[e]=o.charCodeAt(e);const r=new Uint8Array(t),i=new Blob([r],{type:e.mimeType}),l=new File([i],e.fileName,{type:e.mimeType});await C(l,e.category,e.relatedItemId,e.description)}catch(m){console.error("\u274c Error sincronizando archivo ".concat(e.fileName,":"),m)}return console.log("\u2705 Sincronizaci\xf3n completada"),!0}catch(m){return console.error("\u274c Error en sincronizaci\xf3n:",m),!1}},[e,p,C]);return{files:a,isLoading:s,error:m,storageProvider:u,isSupabaseAvailable:p,uploadFile:C,deleteFile:P,loadProjectFiles:N,getFilesByCategory:E,getFilesByRelatedItem:I,searchFiles:x,getFileStats:A,clearProjectFiles:F,switchStorageProvider:z,syncWithSupabase:k,fileLimits:b}}}}]);
//# sourceMappingURL=555.68312c28.chunk.js.map