"use strict";(self.webpackChunkmi_dashboard=self.webpackChunkmi_dashboard||[]).push([[244,283,521,664,902],{1188:(e,a,n)=>{n.d(a,{A6:()=>t,ZY:()=>i,gZ:()=>s,kr:()=>l});const o={OWNER:"owner",ADMIN:"admin",MEMBER_WRITE:"organization_member_write",MEMBER_READ:"organization_member_read"},t={EXECUTIVE:"executive",SPONSOR:"sponsor",PROJECT_MANAGER:"project_manager",FINANCE_MANAGER:"finance_manager",QUALITY_MANAGER:"quality_manager",TECHNICAL_LEAD:"technical_lead",PMO_ASSISTANT:"pmo_assistant",PROJECT_COORDINATOR:"project_coordinator",TEAM_MEMBER:"team_member",AUDITOR:"auditor"},i={[t.EXECUTIVE]:{label:"Ejecutivo",description:"Toma decisiones estrat\xe9gicas y aprueba cambios cr\xedticos",icon:"\ud83d\udc54",color:"purple",badge:"bg-purple-100 text-purple-800"},[t.SPONSOR]:{label:"Patrocinador",description:"Aprueba cambios mayores del proyecto",icon:"\ud83c\udfaf",color:"blue",badge:"bg-blue-100 text-blue-800"},[t.PROJECT_MANAGER]:{label:"Project Manager",description:"Gestiona proyectos y aprueba cambios menores",icon:"\ud83d\udcca",color:"indigo",badge:"bg-indigo-100 text-indigo-800"},[t.FINANCE_MANAGER]:{label:"Gerente Financiero",description:"Aprueba impacto financiero de cambios",icon:"\ud83d\udcb0",color:"green",badge:"bg-green-100 text-green-800"},[t.QUALITY_MANAGER]:{label:"Gerente de Calidad",description:"Valida impacto en calidad",icon:"\u2b50",color:"yellow",badge:"bg-yellow-100 text-yellow-800"},[t.TECHNICAL_LEAD]:{label:"L\xedder T\xe9cnico",description:"Realiza an\xe1lisis t\xe9cnico de cambios",icon:"\ud83d\udd27",color:"cyan",badge:"bg-cyan-100 text-cyan-800"},[t.PMO_ASSISTANT]:{label:"Asistente PMO",description:"Soporte operativo y seguimiento",icon:"\ud83d\udccb",color:"teal",badge:"bg-teal-100 text-teal-800"},[t.PROJECT_COORDINATOR]:{label:"Coordinador de Proyectos",description:"Coordina tareas y actividades",icon:"\ud83d\udcc5",color:"orange",badge:"bg-orange-100 text-orange-800"},[t.TEAM_MEMBER]:{label:"Miembro de Equipo",description:"Participa en el proyecto y solicita cambios",icon:"\ud83d\udc64",color:"gray",badge:"bg-gray-100 text-gray-800"},[t.AUDITOR]:{label:"Auditor",description:"Solo lectura para auditor\xeda",icon:"\ud83d\udd0d",color:"slate",badge:"bg-slate-100 text-slate-800"}},r={[o.OWNER]:{canCreate:!0,canApprove:!0,canReject:!0,canImplement:!0,canVoteInCCB:!0,canAssign:!0,canComment:!0,canViewAll:!0,approvalLimit:{cost:1/0,schedule:1/0},changeRole:"executive_board",level:"unlimited"},[o.ADMIN]:{canCreate:!0,canApprove:!0,canReject:!0,canImplement:!0,canVoteInCCB:!0,canAssign:!0,canComment:!0,canViewAll:!0,approvalLimit:{cost:1/0,schedule:1/0},changeRole:"executive_board",level:"unlimited"},[o.MEMBER_WRITE]:{default:{canCreate:!0,canApprove:!1,canReject:!1,canImplement:!0,canVoteInCCB:!1,canAssign:!1,canComment:!0,canViewAll:!1,approvalLimit:{cost:0,schedule:0},changeRole:"team_member",level:"basic"},[t.EXECUTIVE]:{canCreate:!0,canApprove:!0,canReject:!0,canImplement:!1,canVoteInCCB:!0,canAssign:!0,canComment:!0,canViewAll:!0,approvalLimit:{cost:1/0,schedule:1/0},changeRole:"executive_board",level:"executive"},[t.SPONSOR]:{canCreate:!0,canApprove:!0,canReject:!0,canImplement:!1,canVoteInCCB:!0,canAssign:!0,canComment:!0,canViewAll:!0,approvalLimit:{cost:1e5,schedule:30},changeRole:"sponsor",level:"high"},[t.PROJECT_MANAGER]:{canCreate:!0,canApprove:!0,canReject:!0,canImplement:!0,canVoteInCCB:!0,canAssign:!0,canComment:!0,canViewAll:!0,approvalLimit:{cost:25e3,schedule:15},changeRole:"project_manager",level:"medium"},[t.FINANCE_MANAGER]:{canCreate:!0,canApprove:!0,canReject:!0,canImplement:!1,canVoteInCCB:!0,canAssign:!1,canComment:!0,canViewAll:!0,approvalLimit:{cost:1e5,schedule:0},changeRole:"finance_manager",level:"specialized"},[t.QUALITY_MANAGER]:{canCreate:!0,canApprove:!0,canReject:!0,canImplement:!1,canVoteInCCB:!0,canAssign:!1,canComment:!0,canViewAll:!0,approvalLimit:{cost:0,schedule:0},changeRole:"quality_manager",level:"specialized"},[t.TECHNICAL_LEAD]:{canCreate:!0,canApprove:!1,canReject:!1,canImplement:!0,canVoteInCCB:!0,canAssign:!1,canComment:!0,canViewAll:!1,approvalLimit:{cost:0,schedule:0},changeRole:"technical_lead",level:"technical"},[t.PMO_ASSISTANT]:{canCreate:!0,canApprove:!1,canReject:!1,canImplement:!0,canVoteInCCB:!1,canAssign:!1,canComment:!0,canViewAll:!1,approvalLimit:{cost:0,schedule:0},changeRole:"pmo_assistant",level:"operational"},[t.PROJECT_COORDINATOR]:{canCreate:!0,canApprove:!1,canReject:!1,canImplement:!0,canVoteInCCB:!1,canAssign:!1,canComment:!0,canViewAll:!1,approvalLimit:{cost:0,schedule:0},changeRole:"project_coordinator",level:"operational"},[t.TEAM_MEMBER]:{canCreate:!0,canApprove:!1,canReject:!1,canImplement:!1,canVoteInCCB:!1,canAssign:!1,canComment:!0,canViewAll:!1,approvalLimit:{cost:0,schedule:0},changeRole:"team_member",level:"basic"}},[o.MEMBER_READ]:{default:{canCreate:!0,canApprove:!1,canReject:!1,canImplement:!1,canVoteInCCB:!1,canAssign:!1,canComment:!0,canViewAll:!1,approvalLimit:{cost:0,schedule:0},changeRole:"observer",level:"readonly"},[t.AUDITOR]:{canCreate:!1,canApprove:!1,canReject:!1,canImplement:!1,canVoteInCCB:!1,canAssign:!1,canComment:!0,canViewAll:!0,approvalLimit:{cost:0,schedule:0},changeRole:"auditor",level:"audit"}}},s=function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!e)return{canCreate:!1,canApprove:!1,canReject:!1,canImplement:!1,canVoteInCCB:!1,canAssign:!1,canComment:!1,canViewAll:!1,approvalLimit:{cost:0,schedule:0},changeRole:"none",level:"none"};const n=r[e];return n?e===o.OWNER||e===o.ADMIN?n:a&&n[a]?n[a]:n.default||n:r[o.MEMBER_READ].default},l=e=>{var a;return e?(null===(a=i[e])||void 0===a?void 0:a.label)||e:"Sin rol espec\xedfico"}},3244:(e,a,n)=>{n.r(a),n.d(a,{default:()=>k});var o=n(9950),t=n(7902),i=n(9874),r=n(1188);const s={OWNER:"owner",ADMIN:"admin",MEMBER_WRITE:"member_write",MEMBER_READ:"member_read"},l={[s.OWNER]:"\ud83d\udc51 Propietario",[s.ADMIN]:"\ud83d\udc51 Administrador",[s.MEMBER_WRITE]:"\u270f\ufe0f Miembro (Editar)",[s.MEMBER_READ]:"\ud83d\udc40 Miembro (Solo lectura)"},c={[s.OWNER]:"Control total de la organizaci\xf3n, puede gestionar miembros y proyectos",[s.ADMIN]:"Puede gestionar usuarios y proyectos de la organizaci\xf3n",[s.MEMBER_WRITE]:"Puede crear, editar y eliminar proyectos de la organizaci\xf3n",[s.MEMBER_READ]:"Solo puede ver proyectos de la organizaci\xf3n"},d={[s.OWNER]:{canInvite:!0,canEditRoles:!0,canRemoveMembers:!0,canEditProjects:!0,canDeleteProjects:!0,canViewAll:!0},[s.ADMIN]:{canInvite:!0,canEditRoles:!0,canRemoveMembers:!1,canEditProjects:!0,canDeleteProjects:!0,canViewAll:!0},[s.MEMBER_WRITE]:{canInvite:!1,canEditRoles:!1,canRemoveMembers:!1,canEditProjects:!0,canDeleteProjects:!1,canViewAll:!0},[s.MEMBER_READ]:{canInvite:!1,canEditRoles:!1,canRemoveMembers:!1,canEditProjects:!1,canDeleteProjects:!1,canViewAll:!0}},m={organization_owner:s.OWNER,organization_member_write:s.MEMBER_WRITE,organization_member_read:s.MEMBER_READ,admin:s.ADMIN,owner:s.OWNER,member:s.MEMBER_WRITE},u=[{value:s.OWNER,label:l[s.OWNER],description:c[s.OWNER]},{value:s.ADMIN,label:l[s.ADMIN],description:c[s.ADMIN]},{value:s.MEMBER_WRITE,label:l[s.MEMBER_WRITE],description:c[s.MEMBER_WRITE]},{value:s.MEMBER_READ,label:l[s.MEMBER_READ],description:c[s.MEMBER_READ]}],p=e=>m[e]||s.MEMBER_READ,g=e=>Object.values(s).includes(e),x=e=>d[e]||d[s.MEMBER_READ],b=(e,a)=>!0===x(e)[a],v=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const{fallbackFromProject:a=null,required:n=!0}=e,[t,r]=(0,o.useState)(null),[s,l]=(0,o.useState)(!0),[c,d]=(0,o.useState)(null);return(0,o.useEffect)(()=>{(async()=>{try{if(console.log("\ud83d\udd0d useOrganizationId - Iniciando detecci\xf3n",{fallbackFromProject:a,required:n}),l(!0),d(null),a)return console.log("\u2705 Organization ID detectado desde proyecto:",a),r(a),void l(!1);console.log("\u23ed\ufe0f No hay fallbackFromProject, intentando desde servicio...");const e=i.default.getCurrentOrganization();if(e)return console.log("\u2705 Organization ID detectado desde servicio:",e),r(e),void l(!1);console.log("\ud83d\udd0d Intentando detectar organizaci\xf3n autom\xe1ticamente...");const o=await i.default.detectUserOrganization();if(o&&o.id)return console.log("\u2705 Organization ID auto-detectado:",o.id),console.log("\u2705 Nombre de organizaci\xf3n:",o.name),console.log("\u2705 Rol del usuario:",o.role),r(o.id),void l(!1);const t="No se pudo detectar organization_id. El usuario no pertenece a ninguna organizaci\xf3n.";console.error("\u274c",t),n&&d(t),r(null),l(!1)}catch(e){console.error("\u274c Error detectando organizaci\xf3n:",e),d(e.message),r(null),l(!1)}})()},[a,n]),{organizationId:t,loading:s,error:c,isValid:!!t,hasError:!!c}};var h=n(2556);const E=()=>(0,o.useMemo)(()=>({mapRole:e=>e?p(e):"member_read",isValidRole:g,getRolePermissions:x,hasPermission:b,validateRoleConsistency:e=>{const a=[],n={total:e.length,valid:0,invalid:0,legacy:0};return e.forEach(e=>{const o=e.role,t=p(o);o!==t&&n.legacy++,g(t)?n.valid++:(n.invalid++,a.push({user:e.user_email||e.email,originalRole:o,mappedRole:t,issue:"Mapped role is not valid"}))}),{issues:a,stats:n,isConsistent:0===a.length}}}),[]),A=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];const{currentUser:a,userEmail:n,isAuthenticated:t}=(0,h.A)(),{mapRole:i,hasPermission:r}=E();return(0,o.useMemo)(()=>{if(!t||!n)return{currentUser:null,currentUserMembership:null,currentUserRole:null,mappedRole:null,isOwnerOrAdmin:!1,isOwner:!1,isAdmin:!1,isMember:!1,canInvite:!1,canEditRoles:!1,canRemoveMembers:!1};const o=e.find(e=>e.user_email===n);if(!o)return{currentUser:a,currentUserMembership:null,currentUserRole:null,mappedRole:null,isOwnerOrAdmin:!1,isOwner:!1,isAdmin:!1,isMember:!1,canInvite:!1,canEditRoles:!1,canRemoveMembers:!1};const l=o.role,c=i(l),d=c===s.OWNER,m=c===s.ADMIN;return{currentUser:a,currentUserMembership:o,currentUserRole:l,mappedRole:c,isOwnerOrAdmin:d||m,isOwner:d,isAdmin:m,isMember:c===s.MEMBER_WRITE||c===s.MEMBER_READ,canInvite:r(c,"canInvite"),canEditRoles:r(c,"canEditRoles"),canRemoveMembers:r(c,"canRemoveMembers"),canEditMember:e=>{if(!r(c,"canEditRoles"))return!1;if(d)return!0;return i(null===e||void 0===e?void 0:e.role)!==s.OWNER},canRemoveMember:e=>{if(!r(c,"canRemoveMembers"))return!1;if((null===e||void 0===e?void 0:e.user_email)===n)return!1;if(d)return!0;const a=i(null===e||void 0===e?void 0:e.role);return a!==s.OWNER&&a!==s.ADMIN}}},[e,a,n,t,i,r])};var j=n(9379);const N={showModal:!1,email:"",role:"organization_member_write",functionalRole:"",isLoading:!1,error:null},R="OPEN_MODAL",f="CLOSE_MODAL",y="SET_EMAIL",C="SET_ROLE",_="SET_FUNCTIONAL_ROLE",I="SET_LOADING",M="SET_ERROR",w="RESET_FORM";function O(e,a){switch(a.type){case R:return(0,j.A)((0,j.A)({},e),{},{showModal:!0});case f:return(0,j.A)((0,j.A)({},e),{},{showModal:!1});case y:return(0,j.A)((0,j.A)({},e),{},{email:a.payload});case C:return(0,j.A)((0,j.A)({},e),{},{role:a.payload});case _:return(0,j.A)((0,j.A)({},e),{},{functionalRole:a.payload});case I:return(0,j.A)((0,j.A)({},e),{},{isLoading:a.payload});case M:return(0,j.A)((0,j.A)({},e),{},{error:a.payload});case w:return(0,j.A)((0,j.A)({},N),{},{showModal:e.showModal});default:return e}}const S=()=>{const[e,a]=(0,o.useReducer)(O,N);return{state:e,actions:{openModal:()=>a({type:R}),closeModal:()=>a({type:f}),setEmail:e=>a({type:y,payload:e}),setRole:e=>a({type:C,payload:e}),setFunctionalRole:e=>a({type:_,payload:e}),setLoading:e=>a({type:I,payload:e}),setError:e=>a({type:M,payload:e}),resetForm:()=>a({type:w})}}};function T(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";const a=function(){const e={NODE_ENV:"production",PUBLIC_URL:"",WDS_SOCKET_HOST:void 0,WDS_SOCKET_PATH:void 0,WDS_SOCKET_PORT:void 0,FAST_REFRESH:!0}.REACT_APP_BASE_URL;if(e)return e;const a=window.location.hostname;return"localhost"===a||"127.0.0.1"===a?"http://".concat(a,":").concat(window.location.port||3e3):window.location.origin}(),n=e.startsWith("/")?e:"/".concat(e);return"".concat(a).concat(n)}var z=n(4414);const P=function(e){let{isOpen:a,onClose:n,invitation:t}=e;const[i,r]=(0,o.useState)(!1);if(!a||!t)return null;const s=T("/signup?email=".concat(encodeURIComponent(t.user_email),"&invited=true&org=").concat(t.organization_id));return(0,z.jsx)("div",{className:"invitation-modal-overlay",onClick:n,children:(0,z.jsxs)("div",{className:"invitation-modal",onClick:e=>e.stopPropagation(),children:[(0,z.jsxs)("div",{className:"invitation-modal-header",children:[(0,z.jsx)("h2",{children:"\u2705 Invitaci\xf3n Creada"}),(0,z.jsx)("button",{className:"close-button",onClick:n,children:"\xd7"})]}),(0,z.jsxs)("div",{className:"invitation-modal-body",children:[(0,z.jsxs)("div",{className:"invitation-info",children:[(0,z.jsxs)("p",{className:"invited-email",children:["\ud83d\udce7 ",(0,z.jsx)("strong",{children:t.user_email})]}),(0,z.jsxs)("p",{className:"invited-role",children:["Rol: ",(0,z.jsx)("span",{className:"role-badge",children:t.role})]})]}),(0,z.jsxs)("div",{className:"invitation-instructions",children:[(0,z.jsx)("h3",{children:"\ud83d\udccb C\xf3mo compartir esta invitaci\xf3n:"}),(0,z.jsxs)("ol",{children:[(0,z.jsx)("li",{children:"Copia el enlace de abajo"}),(0,z.jsx)("li",{children:"Env\xedalo al usuario por WhatsApp, email, o Slack"}),(0,z.jsx)("li",{children:"El usuario solo debe hacer clic y registrarse"}),(0,z.jsx)("li",{children:"Una vez registrado, tendr\xe1 acceso autom\xe1tico"})]})]}),(0,z.jsxs)("div",{className:"invitation-link-section",children:[(0,z.jsx)("label",{children:"\ud83d\udd17 Enlace de invitaci\xf3n:"}),(0,z.jsxs)("div",{className:"link-container",children:[(0,z.jsx)("input",{type:"text",value:s,readOnly:!0,className:"invitation-link-input"}),(0,z.jsx)("button",{className:"copy-button ".concat(i?"copied":""),onClick:async()=>{try{await navigator.clipboard.writeText(s),r(!0),setTimeout(()=>r(!1),3e3)}catch(e){console.error("Error copiando enlace:",e);const a=document.createElement("textarea");a.value=s,document.body.appendChild(a),a.select(),document.execCommand("copy"),document.body.removeChild(a),r(!0),setTimeout(()=>r(!1),3e3)}},children:i?"\u2705 Copiado":"\ud83d\udccb Copiar"})]})]}),(0,z.jsxs)("div",{className:"share-options",children:[(0,z.jsx)("h4",{children:"O compartir directamente:"}),(0,z.jsxs)("div",{className:"share-buttons",children:[(0,z.jsx)("button",{className:"share-btn whatsapp",onClick:()=>{const e=encodeURIComponent("\ud83c\udf89 \xa1Has sido invitado a unirte a nuestra organizaci\xf3n en StrategiaPM!\n\n"+"Haz clic en este enlace para registrarte:\n".concat(s,"\n\n")+"Importante: Usa el email ".concat(t.user_email," al registrarte."));window.open("https://wa.me/?text=".concat(e),"_blank")},children:"\ud83d\udcac WhatsApp"}),(0,z.jsx)("button",{className:"share-btn email",onClick:()=>{const e=encodeURIComponent("Invitaci\xf3n a StrategiaPM"),a=encodeURIComponent("Has sido invitado a unirte a nuestra organizaci\xf3n en StrategiaPM.\n\n"+"Haz clic en este enlace para registrarte:\n".concat(s,"\n\n")+"Importante: Debes registrarte usando el email ".concat(t.user_email,"\n\n")+"Una vez registrado, tendr\xe1s acceso autom\xe1tico a la organizaci\xf3n.");window.location.href="mailto:".concat(t.user_email,"?subject=").concat(e,"&body=").concat(a)},children:"\ud83d\udce7 Email"})]})]}),(0,z.jsx)("div",{className:"invitation-note",children:(0,z.jsxs)("p",{children:["\u26a0\ufe0f ",(0,z.jsx)("strong",{children:"Importante:"})," El usuario debe registrarse usando exactamente el email ",(0,z.jsx)("strong",{children:t.user_email})]})})]}),(0,z.jsx)("div",{className:"invitation-modal-footer",children:(0,z.jsx)("button",{className:"btn-primary",onClick:n,children:"Entendido"})})]})})},k=e=>{let{currentProject:a,useSupabase:c=!1,onMemberAdded:d}=e;const[m,g]=(0,o.useState)([]),[x,b]=(0,o.useState)([]),{state:h,actions:E}=S(),j=h.showModal,N=h.email,R=h.role,f=h.functionalRole,y=e=>e?E.openModal():E.closeModal(),C=E.setEmail,_=E.setRole,I=E.setFunctionalRole,[M,w]=(0,o.useState)(!1),[O,T]=(0,o.useState)(null),[k,D]=(0,o.useState)(""),[L,U]=(0,o.useState)(!1),[Y,B]=(0,o.useState)(null),[V,Z]=(0,o.useState)(null),[W,G]=(0,o.useState)(""),[F,q]=(0,o.useState)(!1),[J,H]=(0,o.useState)(null),{addAuditEvent:X}=(0,t.A)(null===a||void 0===a?void 0:a.id,c),{organizationId:Q,loading:K,error:$}=v({fallbackFromProject:null===a||void 0===a?void 0:a.organization_id,required:!0});(0,o.useEffect)(()=>{console.log("\ud83d\udd0d OrganizationMembers - Estado actual:",{hasCurrentProject:!!a,currentProjectOrgId:null===a||void 0===a?void 0:a.organization_id,organizationId:Q,orgLoading:K,orgError:$,useSupabase:c})},[a,Q,K,$,c]);const{isOwnerOrAdmin:ee,canInvite:ae,canEditRoles:ne,canRemoveMembers:oe,canEditMember:te,canRemoveMember:ie}=A(m),re=async()=>{if(console.log("\ud83d\udd04 loadOrganizationMembers ejecut\xe1ndose",{useSupabase:c,organizationId:Q}),c){if(!Q)return console.warn("\u26a0\ufe0f organizationId es null/undefined, esperando detecci\xf3n..."),void console.warn("\u26a0\ufe0f Estado actual:",{orgLoading:K,orgError:$,currentProjectOrgId:null===a||void 0===a?void 0:a.organization_id});console.log("\u2705 Iniciando carga de miembros para organization_id:",Q);try{U(!0);const{default:e}=await Promise.resolve().then(n.bind(n,9874));if(e.isAuthenticated()){e.getCurrentUser();const{data:a,error:n}=await e.supabase.from("organization_members").select("*"),{data:o,error:t}=await e.supabase.from("organization_members").select("*").eq("organization_id",Q).order("joined_at",{ascending:!1});if(t)B("Error cargando miembros de la organizaci\xf3n");else{const e=(o||[]).filter(e=>"active"===e.status);g(e);const a=(o||[]).filter(e=>"pending"===e.status);b(a),console.log("\u2705 Total de miembros cargados:",(null===o||void 0===o?void 0:o.length)||0),console.log("\u2705 Miembros activos:",e.length),console.log("\u23f3 Invitaciones pendientes:",a.length)}}}catch(Y){B("Error cargando miembros de la organizaci\xf3n")}finally{U(!1)}}else console.warn("\u26a0\ufe0f Supabase no est\xe1 habilitado, no se cargar\xe1n miembros")},se=e=>{var a;let{member:n,isInviteForm:o=!1,value:t,onChange:s}=e;const l=null===(a=m.find(e=>{var a;return e.user_email===(null===(a=i.default.getCurrentUser())||void 0===a?void 0:a.email)}))||void 0===a?void 0:a.role,c="owner"===l||"admin"===l;if(o)return(0,z.jsxs)("div",{children:[(0,z.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Rol Funcional (Opcional)"}),(0,z.jsxs)("select",{value:t||"",onChange:e=>s(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:[(0,z.jsx)("option",{value:"",children:"Sin rol espec\xedfico"}),(0,z.jsxs)("optgroup",{label:"Roles de Gesti\xf3n",children:[(0,z.jsxs)("option",{value:r.A6.EXECUTIVE,children:[r.ZY[r.A6.EXECUTIVE].icon," ",r.ZY[r.A6.EXECUTIVE].label]}),(0,z.jsxs)("option",{value:r.A6.SPONSOR,children:[r.ZY[r.A6.SPONSOR].icon," ",r.ZY[r.A6.SPONSOR].label]}),(0,z.jsxs)("option",{value:r.A6.PROJECT_MANAGER,children:[r.ZY[r.A6.PROJECT_MANAGER].icon," ",r.ZY[r.A6.PROJECT_MANAGER].label]})]}),(0,z.jsxs)("optgroup",{label:"Roles Especializados",children:[(0,z.jsxs)("option",{value:r.A6.FINANCE_MANAGER,children:[r.ZY[r.A6.FINANCE_MANAGER].icon," ",r.ZY[r.A6.FINANCE_MANAGER].label]}),(0,z.jsxs)("option",{value:r.A6.QUALITY_MANAGER,children:[r.ZY[r.A6.QUALITY_MANAGER].icon," ",r.ZY[r.A6.QUALITY_MANAGER].label]}),(0,z.jsxs)("option",{value:r.A6.TECHNICAL_LEAD,children:[r.ZY[r.A6.TECHNICAL_LEAD].icon," ",r.ZY[r.A6.TECHNICAL_LEAD].label]})]}),(0,z.jsxs)("optgroup",{label:"Roles Operativos",children:[(0,z.jsxs)("option",{value:r.A6.PMO_ASSISTANT,children:[r.ZY[r.A6.PMO_ASSISTANT].icon," ",r.ZY[r.A6.PMO_ASSISTANT].label]}),(0,z.jsxs)("option",{value:r.A6.PROJECT_COORDINATOR,children:[r.ZY[r.A6.PROJECT_COORDINATOR].icon," ",r.ZY[r.A6.PROJECT_COORDINATOR].label]}),(0,z.jsxs)("option",{value:r.A6.TEAM_MEMBER,children:[r.ZY[r.A6.TEAM_MEMBER].icon," ",r.ZY[r.A6.TEAM_MEMBER].label]})]}),(0,z.jsx)("optgroup",{label:"Roles de Supervisi\xf3n",children:(0,z.jsxs)("option",{value:r.A6.AUDITOR,children:[r.ZY[r.A6.AUDITOR].icon," ",r.ZY[r.A6.AUDITOR].label]})})]}),(0,z.jsx)("p",{className:"text-xs text-gray-500 mt-1",children:t&&r.ZY[t]?r.ZY[t].description:"El rol funcional determina los permisos en control de cambios"})]});if(V===n.id)return(0,z.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,z.jsxs)("select",{value:W,onChange:e=>G(e.target.value),className:"px-2 py-1 border border-gray-300 rounded text-sm",children:[(0,z.jsx)("option",{value:"",children:"Sin rol espec\xedfico"}),(0,z.jsxs)("optgroup",{label:"Gesti\xf3n",children:[(0,z.jsxs)("option",{value:r.A6.EXECUTIVE,children:[r.ZY[r.A6.EXECUTIVE].icon," ",r.ZY[r.A6.EXECUTIVE].label]}),(0,z.jsxs)("option",{value:r.A6.SPONSOR,children:[r.ZY[r.A6.SPONSOR].icon," ",r.ZY[r.A6.SPONSOR].label]}),(0,z.jsxs)("option",{value:r.A6.PROJECT_MANAGER,children:[r.ZY[r.A6.PROJECT_MANAGER].icon," ",r.ZY[r.A6.PROJECT_MANAGER].label]})]}),(0,z.jsxs)("optgroup",{label:"Especializados",children:[(0,z.jsxs)("option",{value:r.A6.FINANCE_MANAGER,children:[r.ZY[r.A6.FINANCE_MANAGER].icon," ",r.ZY[r.A6.FINANCE_MANAGER].label]}),(0,z.jsxs)("option",{value:r.A6.QUALITY_MANAGER,children:[r.ZY[r.A6.QUALITY_MANAGER].icon," ",r.ZY[r.A6.QUALITY_MANAGER].label]}),(0,z.jsxs)("option",{value:r.A6.TECHNICAL_LEAD,children:[r.ZY[r.A6.TECHNICAL_LEAD].icon," ",r.ZY[r.A6.TECHNICAL_LEAD].label]})]}),(0,z.jsxs)("optgroup",{label:"Operativos",children:[(0,z.jsxs)("option",{value:r.A6.PMO_ASSISTANT,children:[r.ZY[r.A6.PMO_ASSISTANT].icon," ",r.ZY[r.A6.PMO_ASSISTANT].label]}),(0,z.jsxs)("option",{value:r.A6.PROJECT_COORDINATOR,children:[r.ZY[r.A6.PROJECT_COORDINATOR].icon," ",r.ZY[r.A6.PROJECT_COORDINATOR].label]}),(0,z.jsxs)("option",{value:r.A6.TEAM_MEMBER,children:[r.ZY[r.A6.TEAM_MEMBER].icon," ",r.ZY[r.A6.TEAM_MEMBER].label]})]}),(0,z.jsx)("optgroup",{label:"Supervisi\xf3n",children:(0,z.jsxs)("option",{value:r.A6.AUDITOR,children:[r.ZY[r.A6.AUDITOR].icon," ",r.ZY[r.A6.AUDITOR].label]})})]}),(0,z.jsx)("button",{onClick:()=>(async(e,a)=>{try{U(!0);const{error:n}=await i.default.supabase.from("organization_members").update({functional_role:a||null,updated_at:(new Date).toISOString()}).eq("id",e).eq("organization_id",Q);if(n)return console.error("Error actualizando rol funcional:",n),void alert("Error actualizando rol funcional: "+n.message);await re(),Z(null),G(""),alert("Rol funcional actualizado exitosamente")}catch(Y){console.error("Error actualizando rol funcional:",Y),alert("Error actualizando rol funcional")}finally{U(!1)}})(n.id,W),className:"px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700",children:"\u2713"}),(0,z.jsx)("button",{onClick:()=>{Z(null),G("")},className:"px-3 py-1 bg-gray-300 text-gray-700 rounded text-sm hover:bg-gray-400",children:"\u2715"})]});const d=n.functional_role?r.ZY[n.functional_role]:null;return(0,z.jsxs)("div",{className:"flex items-center justify-between",children:[(0,z.jsx)("div",{children:d?(0,z.jsxs)("span",{className:"px-3 py-1 rounded-full text-xs font-medium ".concat(d.badge),children:[d.icon," ",d.label]}):(0,z.jsx)("span",{className:"text-gray-400 text-sm italic",children:"Sin rol espec\xedfico"})}),c&&"active"===n.status&&(0,z.jsx)("button",{onClick:()=>{Z(n.id),G(n.functional_role||"")},className:"ml-2 text-blue-600 hover:text-blue-800 text-sm",title:"Editar rol funcional",children:"\u270f\ufe0f"})]})};if((0,o.useEffect)(()=>{re()},[Q,c]),!c)return(0,z.jsx)("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:(0,z.jsxs)("div",{className:"flex items-center",children:[(0,z.jsx)("span",{className:"text-yellow-600 text-xl mr-3",children:"\u26a0\ufe0f"}),(0,z.jsxs)("div",{children:[(0,z.jsx)("h3",{className:"text-yellow-800 font-medium",children:"Supabase no habilitado"}),(0,z.jsx)("p",{className:"text-yellow-700 text-sm",children:"Para compartir proyectos con otros usuarios, necesitas habilitar Supabase en la configuraci\xf3n."})]})]})});if(K)return(0,z.jsx)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:(0,z.jsxs)("div",{className:"flex items-center",children:[(0,z.jsx)("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mr-3"}),(0,z.jsx)("p",{className:"text-blue-700",children:"Detectando organizaci\xf3n..."})]})});if(!Q||$)return(0,z.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:(0,z.jsxs)("div",{className:"flex items-center",children:[(0,z.jsx)("span",{className:"text-red-600 text-xl mr-3",children:"\u274c"}),(0,z.jsxs)("div",{children:[(0,z.jsx)("h3",{className:"text-red-800 font-medium",children:"No se detect\xf3 organizaci\xf3n"}),(0,z.jsx)("p",{className:"text-red-700 text-sm",children:$||"Este usuario no pertenece a ninguna organizaci\xf3n. Por favor, solicita una invitaci\xf3n."})]})]})});const le=e=>{switch(e){case"owner":return"bg-purple-100 text-purple-800";case"admin":return"bg-blue-100 text-blue-800";case"member":return"bg-green-100 text-green-800";default:return"bg-gray-100 text-gray-800"}},ce=e=>{const a=p(e);return l[a]||e};return(0,z.jsxs)("div",{className:"space-y-6",children:[(0,z.jsxs)("div",{className:"flex items-center justify-between",children:[(0,z.jsxs)("div",{children:[(0,z.jsx)("h2",{className:"text-2xl font-bold text-gray-800",children:"Miembros de la Organizaci\xf3n"}),(0,z.jsx)("p",{className:"text-gray-600",children:"Gestiona qui\xe9n puede ver y editar los proyectos de tu organizaci\xf3n"})]}),ae?(0,z.jsxs)("button",{onClick:()=>y(!0),className:"bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center space-x-2",children:[(0,z.jsx)("span",{children:"+"}),(0,z.jsx)("span",{children:"Invitar Miembro"})]}):(0,z.jsxs)("div",{className:"text-sm text-gray-500 italic bg-gray-50 px-3 py-2 rounded-lg border",children:[(0,z.jsx)("span",{children:"\ud83d\udd12"})," Solo administradores pueden invitar miembros"]})]}),Y&&(0,z.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:(0,z.jsxs)("div",{className:"flex items-center",children:[(0,z.jsx)("span",{className:"text-red-600 text-xl mr-3",children:"\u274c"}),(0,z.jsxs)("div",{children:[(0,z.jsx)("h3",{className:"text-red-800 font-medium",children:"Error"}),(0,z.jsx)("p",{className:"text-red-700 text-sm",children:Y})]})]})}),(0,z.jsx)("div",{className:"mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4",children:(0,z.jsxs)("div",{className:"flex items-start",children:[(0,z.jsx)("span",{className:"text-blue-500 text-xl mr-3",children:"\u2139\ufe0f"}),(0,z.jsxs)("div",{children:[(0,z.jsx)("h4",{className:"font-semibold text-blue-800 mb-2",children:"Roles Funcionales en Control de Cambios"}),(0,z.jsx)("p",{className:"text-sm text-blue-700 mb-2",children:"Los roles funcionales determinan los permisos espec\xedficos en el m\xf3dulo de Control de Cambios:"}),(0,z.jsxs)("ul",{className:"text-sm text-blue-700 space-y-1",children:[(0,z.jsxs)("li",{children:[(0,z.jsx)("strong",{children:"Ejecutivo/Sponsor:"})," Aprueban cambios mayores sin l\xedmite"]}),(0,z.jsxs)("li",{children:[(0,z.jsx)("strong",{children:"Project Manager:"})," Aprueban cambios hasta $25K / 15 d\xedas"]}),(0,z.jsxs)("li",{children:[(0,z.jsx)("strong",{children:"Gerente Financiero:"})," Validan impacto financiero"]}),(0,z.jsxs)("li",{children:[(0,z.jsx)("strong",{children:"Miembro de Equipo:"})," Solo pueden solicitar cambios"]}),(0,z.jsxs)("li",{children:[(0,z.jsx)("strong",{children:"Sin rol espec\xedfico:"})," Permisos b\xe1sicos seg\xfan rol organizacional"]})]})]})]})}),x.length>0&&(0,z.jsxs)("div",{className:"bg-yellow-50 rounded-lg shadow-sm border border-yellow-200",children:[(0,z.jsxs)("div",{className:"p-4 border-b border-yellow-200",children:[(0,z.jsxs)("h3",{className:"text-lg font-semibold text-yellow-800 flex items-center",children:[(0,z.jsx)("span",{className:"mr-2",children:"\u23f3"}),"Invitaciones Pendientes (",x.length,")"]}),(0,z.jsx)("p",{className:"text-sm text-yellow-700 mt-1",children:"Estas personas fueron invitadas pero a\xfan no han aceptado"})]}),(0,z.jsx)("div",{className:"divide-y divide-yellow-200",children:x.map(e=>{var a,n;return(0,z.jsx)("div",{className:"p-4",children:(0,z.jsxs)("div",{className:"flex items-start justify-between",children:[(0,z.jsxs)("div",{className:"flex items-start space-x-4 flex-1",children:[(0,z.jsx)("div",{className:"w-12 h-12 bg-yellow-300 rounded-full flex items-center justify-center flex-shrink-0",children:(0,z.jsx)("span",{className:"text-yellow-800 font-bold text-lg",children:"\u2709\ufe0f"})}),(0,z.jsxs)("div",{className:"flex-1",children:[(0,z.jsxs)("div",{className:"flex items-center space-x-2 mb-1",children:[(0,z.jsx)("p",{className:"font-semibold text-yellow-900 text-lg",children:e.user_email}),(0,z.jsx)("span",{className:"px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-200 text-yellow-800",children:"\u23f3 Pendiente"})]}),(0,z.jsxs)("div",{className:"space-y-1",children:[(0,z.jsxs)("p",{className:"text-sm text-yellow-700",children:[(0,z.jsx)("span",{className:"font-medium",children:"Rol:"})," ",ce(e.role)]}),e.functional_role&&(0,z.jsxs)("p",{className:"text-sm text-yellow-700",children:[(0,z.jsx)("span",{className:"font-medium",children:"Rol Funcional:"})," ",null===(a=r.ZY[e.functional_role])||void 0===a?void 0:a.icon," ",null===(n=r.ZY[e.functional_role])||void 0===n?void 0:n.label]}),e.invited_by&&(0,z.jsxs)("p",{className:"text-xs text-yellow-600 mt-2",children:["Invitado por ",(0,z.jsx)("span",{className:"font-medium",children:e.invited_by}),e.invited_at&&(0,z.jsxs)("span",{children:[" el ",new Date(e.invited_at).toLocaleDateString("es-MX",{year:"numeric",month:"long",day:"numeric"})]})]}),e.created_at&&!e.invited_at&&(0,z.jsxs)("p",{className:"text-xs text-yellow-600 mt-2",children:["Invitado el ",new Date(e.created_at).toLocaleDateString("es-MX",{year:"numeric",month:"long",day:"numeric"})]})]})]})]}),oe&&(0,z.jsxs)("div",{className:"flex flex-col space-y-2 ml-4",children:[(0,z.jsxs)("button",{onClick:()=>(async e=>{try{const a=x.find(a=>a.id===e);if(!a)return;console.log("Reenviando invitaci\xf3n:",e);const n="localhost"===window.location.hostname?"https://strategiapm.vercel.app":window.location.origin;alert("\ud83d\udce7 Recordatorio de invitaci\xf3n\n      \nSe ha notificado nuevamente a ".concat(a.user_email,"\n\nComparte este enlace para que se registren:\n").concat(n,"\n\nUna vez registrado con ese email, tendr\xe1 acceso autom\xe1ticamente."))}catch(Y){console.error("Error reenviando invitaci\xf3n:",Y),alert("Error al reenviar invitaci\xf3n")}})(e.id),className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium flex items-center space-x-1 transition-colors",title:"Reenviar invitaci\xf3n",children:[(0,z.jsx)("span",{children:"\ud83d\udd04"}),(0,z.jsx)("span",{children:"Reenviar"})]}),(0,z.jsxs)("button",{onClick:()=>(async(e,a)=>{try{if(!window.confirm("\xbfEst\xe1s seguro de cancelar la invitaci\xf3n para ".concat(a,"?")))return;console.log("\ud83d\uddd1\ufe0f Cancelando invitaci\xf3n:",e);const{error:n}=await i.default.supabase.from("organization_members").delete().eq("id",e);if(n)return console.error("\u274c Error cancelando invitaci\xf3n:",n),void alert("Error al cancelar invitaci\xf3n: ".concat(n.message));console.log("\u2705 Invitaci\xf3n cancelada exitosamente"),alert("\u2705 Invitaci\xf3n cancelada"),re()}catch(n){console.error("\u274c Error inesperado:",n),alert("Error: ".concat(n.message))}})(e.id,e.user_email),className:"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm font-medium flex items-center space-x-1 transition-colors",title:"Cancelar invitaci\xf3n",children:[(0,z.jsx)("span",{children:"\u274c"}),(0,z.jsx)("span",{children:"Cancelar"})]})]})]})},e.id)})})]}),(0,z.jsxs)("div",{className:"bg-white rounded-lg shadow-sm border",children:[(0,z.jsx)("div",{className:"p-4 border-b",children:(0,z.jsxs)("h3",{className:"text-lg font-semibold text-gray-800",children:["Miembros Activos (",m.length,")"]})}),(0,z.jsx)("div",{className:"divide-y divide-gray-200",children:L?(0,z.jsxs)("div",{className:"p-8 text-center",children:[(0,z.jsx)("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"}),(0,z.jsx)("p",{className:"text-gray-600 mt-2",children:"Cargando miembros..."})]}):0===m.length?(0,z.jsxs)("div",{className:"p-8 text-center text-gray-500",children:[(0,z.jsx)("span",{className:"text-4xl mb-4 block",children:"\ud83d\udc65"}),(0,z.jsx)("p",{children:"No hay miembros en la organizaci\xf3n"}),(0,z.jsx)("p",{className:"text-sm",children:"Invita a otros usuarios para compartir tus proyectos"})]}):m.map(e=>(0,z.jsxs)("div",{className:"p-4 flex items-center justify-between",children:[(0,z.jsxs)("div",{className:"flex items-center space-x-4",children:[(0,z.jsx)("div",{className:"w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center",children:(0,z.jsx)("span",{className:"text-gray-600 font-medium",children:e.user_email.charAt(0).toUpperCase()})}),(0,z.jsxs)("div",{children:[(0,z.jsx)("p",{className:"font-medium text-gray-900",children:e.user_email}),(0,z.jsxs)("p",{className:"text-sm text-gray-500",children:["Se uni\xf3 el ",new Date(e.joined_at).toLocaleDateString()]})]})]}),(0,z.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,z.jsx)("span",{className:"px-2 py-1 rounded-full text-xs font-medium ".concat(le(e.role)),children:ce(e.role)}),(0,z.jsx)(se,{member:e}),(0,z.jsxs)("div",{className:"flex items-center space-x-2",children:[te(e)&&(0,z.jsx)("button",{onClick:()=>(e=>{T(e),D(e.role),w(!0)})(e),className:"text-blue-600 hover:text-blue-800 text-sm",title:"Cambiar rol",children:"\u270f\ufe0f"}),ie(e)&&(0,z.jsx)("button",{onClick:()=>(async(e,a)=>{const o=m.find(a=>a.id===e);if(!ie(o))return void(p(null===o||void 0===o?void 0:o.role)===s.OWNER?alert("\u274c No se puede eliminar al propietario de la organizaci\xf3n."):alert("\u274c No tienes permisos para eliminar este miembro."));if(window.confirm("\u26a0\ufe0f ELIMINACI\xd3N COMPLETA DE USUARIO\n\n\xbfEst\xe1s seguro de que quieres eliminar COMPLETAMENTE a ".concat(a,"?\n\nEsto eliminar\xe1:\n\u2022 Su membres\xeda en la organizaci\xf3n\n\u2022 Todos sus roles y permisos\n\u2022 Su acceso a todos los proyectos\n\nEsta acci\xf3n NO se puede deshacer.")))try{U(!0);const{default:o}=await Promise.resolve().then(n.bind(n,9874));if(o.isAuthenticated()){const{error:n}=await o.supabase.from("organization_members").delete().eq("id",e);if(n)throw new Error("Error eliminando membres\xeda: ".concat(n.message));const{error:r}=await o.supabase.from("user_organization_roles").delete().eq("user_email",a).eq("organization_id",Q);r&&console.warn("\u26a0\ufe0f Error eliminando de user_organization_roles (puede no existir):",r);const{error:s}=await o.supabase.from("tasks").update({assigned_to:null}).eq("assigned_to",a);s&&console.warn("\u26a0\ufe0f Error actualizando tareas:",s);const{error:l}=await o.supabase.from("risks").update({owner:null}).eq("owner",a);l&&console.warn("\u26a0\ufe0f Error actualizando riesgos:",l);try{["mi-dashboard-portfolio","lastSelectedProjectId","portfolioData","audit-log-"+a,"user-preferences-"+a].forEach(e=>{const n=localStorage.getItem(e);if(n)try{const o=JSON.parse(n);JSON.stringify(o).includes(a)&&(console.log("\ud83d\uddd1\ufe0f Limpiando localStorage key: ".concat(e)),localStorage.removeItem(e))}catch(o){console.log("\ud83d\uddd1\ufe0f Limpiando localStorage key (raw): ".concat(e)),localStorage.removeItem(e)}}),["currentUser","userSession","organizationData"].forEach(e=>{const n=sessionStorage.getItem(e);n&&n.includes(a)&&(console.log("\ud83d\uddd1\ufe0f Limpiando sessionStorage key: ".concat(e)),sessionStorage.removeItem(e))})}catch(i){}var t;X&&X({category:"organization",action:"member-completely-removed",description:'Usuario "'.concat(a,'" eliminado COMPLETAMENTE de la organizaci\xf3n'),details:{userEmail:a,organizationId:Q,tablesCleaned:["organization_members","user_organization_roles","tasks","risks"],localCacheCleaned:!0},severity:"high",user:(null===(t=o.getCurrentUser())||void 0===t?void 0:t.email)||"Sistema"});const c="\u2705 Usuario ".concat(a," eliminado COMPLETAMENTE de la organizaci\xf3n\n\nSe elimin\xf3 de:\n\u2022 organization_members (membres\xeda principal)\n\u2022 user_organization_roles (roles y permisos)\n\u2022 Referencias en tareas y riesgos\n\u2022 Cach\xe9 local del navegador\n\n\u26a0\ufe0f IMPORTANTE: El usuario eliminado debe:\n1. Cerrar sesi\xf3n completamente\n2. Cerrar el navegador\n3. Volver a abrir el navegador\n4. Iniciar sesi\xf3n nuevamente\n\nSolo as\xed ver\xe1 que ya no tiene acceso a la organizaci\xf3n.");alert(c),await re()}}catch(Y){console.error("\u274c Error eliminando miembro:",Y),B("Error eliminando miembro: ".concat(Y.message)),alert("\u274c Error eliminando usuario: ".concat(Y.message,"\n\nPor favor, intenta nuevamente o contacta al administrador."))}finally{U(!1)}})(e.id,e.user_email),className:"text-red-600 hover:text-red-800 text-sm",title:"Eliminar miembro",children:"\ud83d\uddd1\ufe0f"})]})]})]},e.id))})]}),j&&(0,z.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:(0,z.jsx)("div",{className:"bg-white rounded-lg max-w-md w-full",children:(0,z.jsxs)("div",{className:"p-6",children:[(0,z.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,z.jsx)("h2",{className:"text-xl font-bold",children:"Invitar Miembro"}),(0,z.jsx)("button",{onClick:()=>y(!1),className:"text-gray-500 hover:text-gray-700 text-xl",children:"\u2715"})]}),(0,z.jsxs)("form",{onSubmit:async e=>{if(e.preventDefault(),N&&Q)if(ae)try{U(!0),B(null);const{default:e}=await Promise.resolve().then(n.bind(n,9874));if(e.isAuthenticated()){var a;e.getCurrentUser();const{data:n,error:t}=await e.supabase.from("user_organization_roles").select("role, organization_id").eq("user_id",null===(a=e.getCurrentUser())||void 0===a?void 0:a.id),{data:i,error:r}=await e.supabase.from("organization_members").select("*").eq("organization_id",Q).eq("user_email",N).single();if(i)return void alert("\u26a0\ufe0f El usuario ".concat(N," ya es miembro de esta organizaci\xf3n."));const{data:s,error:l}=await e.supabase.rpc("invite_member",{p_organization_id:Q,p_user_email:N,p_role:R,p_functional_role:f||null});if(l)throw l;if(s&&!s.success)throw new Error(s.error||"Error al invitar miembro");var o;if(X)X({category:"organization",action:"member-invited",description:'Invitaci\xf3n enviada a "'.concat(N,'" con rol "').concat(R,'"'),details:{userEmail:N,role:R,organizationId:Q},severity:"medium",user:(null===(o=e.getCurrentUser())||void 0===o?void 0:o.email)||"Sistema"});H({user_email:N,role:R,organization_id:Q}),q(!0),await re(),E.resetForm(),E.closeModal(),d&&d()}}catch(Y){console.error("Error invitando miembro:",Y),B("Error invitando miembro: ".concat(Y.message))}finally{U(!1)}else alert("\u274c No tienes permisos para invitar miembros. Solo owners y administradores pueden realizar esta acci\xf3n.")},children:[(0,z.jsxs)("div",{className:"space-y-4",children:[(0,z.jsxs)("div",{children:[(0,z.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email del Usuario *"}),(0,z.jsx)("input",{type:"email",className:"w-full border rounded px-3 py-2",value:N,onChange:e=>C(e.target.value),placeholder:"usuario@ejemplo.com",required:!0})]}),(0,z.jsxs)("div",{children:[(0,z.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Rol"}),(0,z.jsx)("select",{className:"w-full border rounded px-3 py-2",value:R,onChange:e=>_(e.target.value),children:u.map(e=>(0,z.jsx)("option",{value:e.value,children:e.label},e.value))})]})]}),(0,z.jsx)(se,{isInviteForm:!0,value:f,onChange:e=>I(e)}),(0,z.jsxs)("div",{className:"flex justify-end space-x-3 mt-6",children:[(0,z.jsx)("button",{type:"button",onClick:()=>y(!1),className:"px-4 py-2 border border-gray-300 rounded text-gray-700 hover:bg-gray-50",disabled:L,children:"Cancelar"}),(0,z.jsx)("button",{type:"submit",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50",disabled:L,children:L?"Enviando...":"Invitar"})]})]})]})})}),M&&(0,z.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,z.jsx)("div",{className:"bg-white rounded-lg max-w-md w-full mx-4",children:(0,z.jsxs)("div",{className:"p-6",children:[(0,z.jsxs)("div",{className:"flex justify-between items-center mb-4",children:[(0,z.jsx)("h2",{className:"text-xl font-bold",children:"Cambiar Rol de Usuario"}),(0,z.jsx)("button",{onClick:()=>{w(!1),T(null),D("")},className:"text-gray-500 hover:text-gray-700 text-xl",children:"\u2715"})]}),(0,z.jsxs)("div",{className:"mb-4",children:[(0,z.jsxs)("p",{className:"text-gray-600 mb-2",children:["Cambiando rol de: ",(0,z.jsx)("strong",{children:null===O||void 0===O?void 0:O.user_email})]}),(0,z.jsxs)("p",{className:"text-sm text-gray-500",children:["Rol actual: ",(0,z.jsx)("span",{className:"font-medium",children:O?ce(O.role):""})]})]}),(0,z.jsxs)("div",{className:"mb-6",children:[(0,z.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Nuevo Rol"}),(0,z.jsx)("select",{value:k,onChange:e=>D(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500",children:u.map(e=>(0,z.jsx)("option",{value:e.value,children:e.label},e.value))}),(0,z.jsxs)("div",{className:"mt-2 text-xs text-gray-500",children:[(0,z.jsxs)("p",{children:[(0,z.jsx)("strong",{children:"Solo lectura:"})," Puede ver proyectos pero no editarlos"]}),(0,z.jsxs)("p",{children:[(0,z.jsx)("strong",{children:"Editar:"})," Puede ver y modificar proyectos"]}),(0,z.jsxs)("p",{children:[(0,z.jsx)("strong",{children:"Administrador:"})," Puede gestionar usuarios y proyectos"]})]})]}),(0,z.jsxs)("div",{className:"flex justify-end space-x-3",children:[(0,z.jsx)("button",{onClick:()=>{w(!1),T(null),D("")},className:"px-4 py-2 text-gray-600 border border-gray-300 rounded hover:bg-gray-50",disabled:L,children:"Cancelar"}),(0,z.jsx)("button",{onClick:async()=>{if(O&&k){if(!te(O)){return void(p(O.role)===s.OWNER?alert("\u274c No se puede cambiar el rol del propietario de la organizaci\xf3n."):alert("\u274c No tienes permisos para cambiar el rol de este miembro."))}try{U(!0);const{default:a}=await Promise.resolve().then(n.bind(n,9874));if(a.isAuthenticated()){const{error:n}=await a.supabase.from("organization_members").update({role:k}).eq("id",O.id);if(n)throw n;var e;if(X)X({category:"organization",action:"member-role-updated",description:'Rol de "'.concat(O.user_email,'" cambiado a "').concat(ce(k),'"'),details:{userEmail:O.user_email,oldRole:O.role,newRole:k,organizationId:Q},severity:"medium",user:(null===(e=a.getCurrentUser())||void 0===e?void 0:e.email)||"Sistema"});alert("\u2705 Rol de ".concat(O.user_email," actualizado exitosamente")),await re(),w(!1),T(null),D("")}}catch(Y){console.error("Error actualizando rol:",Y),B("Error actualizando rol: ".concat(Y.message))}finally{U(!1)}}},className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50",disabled:L||!k||k===(null===O||void 0===O?void 0:O.role),children:L?"Actualizando...":"Cambiar Rol"})]})]})})}),(0,z.jsx)(P,{isOpen:F,onClose:()=>q(!1),invitation:J})]})}},7902:(e,a,n)=>{n.d(a,{A:()=>i});var o=n(9379),t=n(9950);const i=function(e){let a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const[i,r]=(0,t.useState)([]),[s,l]=(0,t.useState)(!1);(0,t.useEffect)(()=>{(async()=>{if(e){l(!0);try{if(a){const{default:a}=await Promise.resolve().then(n.bind(n,9874));if(a.isAuthenticated()){const n=await a.loadAuditEvents(e);if(n.success)r(n.events),console.log("\u2705 Logs de auditor\xeda cargados desde Supabase para proyecto ".concat(e,": ").concat(n.events.length," eventos"));else{const a=localStorage.getItem("audit-log-".concat(e));r(a?JSON.parse(a):[])}}else{const a=localStorage.getItem("audit-log-".concat(e));r(a?JSON.parse(a):[])}}else{const a=localStorage.getItem("audit-log-".concat(e));r(a?JSON.parse(a):[])}}catch(o){console.error("Error loading audit log:",o);const a=localStorage.getItem("audit-log-".concat(e));a&&r(JSON.parse(a))}finally{l(!1)}}})()},[e,a]);const c=(0,t.useCallback)(async a=>{localStorage.setItem("audit-log-".concat(e),JSON.stringify(a)),console.log("\ud83d\udccb Logs de auditor\xeda guardados en localStorage para proyecto ".concat(e,": ").concat(a.length," eventos"))},[e]),d=(0,t.useCallback)(async o=>{if(a)try{const{default:a}=await Promise.resolve().then(n.bind(n,9874));if(a.isAuthenticated()){const n=await a.saveAuditEvents(e,[o]);n.success?console.log("\u2705 Evento de auditor\xeda guardado en Supabase: ".concat(o.action)):console.warn("\u26a0\ufe0f Error guardando evento en Supabase:",n.error)}}catch(t){console.error("Error guardando evento en Supabase:",t)}},[e,a]),m=(0,t.useCallback)(async a=>{const n=(0,o.A)({id:crypto.randomUUID(),timestamp:(new Date).toISOString(),projectId:e},a);return r(e=>{const a=[n,...e];return c(a),a}),d(n),n},[e,c,d]),u=(0,t.useCallback)((e,a,n)=>{m({category:"project-status",action:"status-changed",description:'Estado del proyecto cambiado de "'.concat(e,'" a "').concat(a,'"'),details:{previousStatus:e,newStatus:a,projectName:n.name,manager:n.manager,budget:n.budget},severity:"high",user:n.manager||"Sistema"})},[m]),p=(0,t.useCallback)((e,a)=>{m({category:"work-package",action:"created",description:'Work Package "'.concat(e.name,'" creado'),details:{workPackageId:e.id,name:e.name,budget:e.budget,status:e.status},severity:"medium",user:a.manager||"Sistema"})},[m]),g=(0,t.useCallback)((e,a,n)=>{m({category:"work-package",action:"modified",description:'Work Package "'.concat(e.name,'" modificado'),details:{workPackageId:e.id,name:e.name,changes:Object.keys(a),previousValues:a},severity:"medium",user:n.manager||"Sistema"})},[m]),x=(0,t.useCallback)((e,a)=>{m({category:"risk",action:"created",description:'Riesgo "'.concat(e.name,'" identificado'),details:{riskId:e.id,name:e.name,probability:e.probability,impact:e.impact,priority:e.priority},severity:"high"===e.priority?"high":"medium",user:a.manager||"Sistema"})},[m]),b=(0,t.useCallback)((e,a,n)=>{const o={"purchase-order":{action:"created",description:'Orden de Compra "'.concat(a.description,'" creada'),details:{poId:a.id,description:a.description,amount:a.amount,supplier:a.supplier}},advance:{action:"created",description:'Anticipo "'.concat(a.description,'" creado'),details:{advanceId:a.id,description:a.description,amount:a.amount,recipient:a.recipient}},invoice:{action:"created",description:'Factura "'.concat(a.description,'" creada'),details:{invoiceId:a.id,description:a.description,amount:a.amount,supplier:a.supplier}},contract:{action:"created",description:'Contrato "'.concat(a.name,'" creado'),details:{contractId:a.id,name:a.name,value:a.value,contractor:a.contractor}}}[e];o&&m({category:"financial",action:o.action,description:o.description,details:o.details,severity:"high",user:n.manager||"Sistema"})},[m]),v=(0,t.useCallback)((e,a)=>{m({category:"resources",action:"assigned",description:"Recurso asignado al proyecto",details:{assignmentId:e.id,resourceId:e.resourceId,role:e.role,allocation:e.allocation},severity:"medium",user:a.manager||"Sistema"})},[m]),h=(0,t.useCallback)((e,a)=>{m({category:"minutes",action:"minute-task-created",description:'Tarea de minuta "'.concat(e.tarea,'" creada'),details:{taskId:e.id,tarea:e.tarea,responsable:e.responsable,fecha:e.fecha,hitoId:e.hitoId,estatus:e.estatus},severity:"medium",user:a.manager||"Sistema"})},[m]),E=(0,t.useCallback)((e,a,n)=>{m({category:"minutes",action:"minute-task-updated",description:'Tarea de minuta "'.concat(e.tarea,'" actualizada'),details:{taskId:e.id,tarea:e.tarea,changes:a,newStatus:e.estatus},severity:"medium",user:n.manager||"Sistema"})},[m]),A=(0,t.useCallback)(()=>{r([]),localStorage.removeItem("audit-log-".concat(e))},[e]),j=(0,t.useCallback)(()=>{const a={projectId:e,exportDate:(new Date).toISOString(),totalEvents:i.length,events:i},n=JSON.stringify(a,null,2),o=new Blob([n],{type:"application/json"}),t=URL.createObjectURL(o),r=document.createElement("a");r.href=t,r.download="audit-log-".concat(e,"-").concat((new Date).toISOString().split("T")[0],".json"),r.click(),URL.revokeObjectURL(t)},[i,e]);return{auditLog:i,isLoading:s,addAuditEvent:m,logProjectStatusChange:u,logWorkPackageCreated:p,logWorkPackageModified:g,logRiskCreated:x,logFinancialEvent:b,logResourceAssignment:v,logMinutaTaskCreated:h,logMinutaTaskUpdated:E,clearAuditLog:A,exportAuditLog:j}}}}]);